<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Portal ‚Äî Orion GLE Ltd</title>
<meta name="robots" content="noindex,nofollow">
<link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
<style>
:root{--bg:#05070d;--text:#fff;--muted:rgba(255,255,255,.72);--line:rgba(255,255,255,.1);--a1:#7c3aed;--a2:#22d3ee}
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:#fff}
.wrap{max-width:1060px;margin:0 auto;padding:22px}.top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:#fff;text-decoration:none;cursor:pointer}
.btn.primary{border:none;background:linear-gradient(135deg,var(--a1),var(--a2));color:#061019;font-weight:700}
.card{margin-top:14px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:16px}
h1{margin:0 0 8px}p,li,label{color:var(--muted);line-height:1.7}.status{font-size:13px;color:#ff9aa2;min-height:20px}
form{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:end}input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:#fff}
textarea{min-height:74px;resize:vertical}
#addForm{grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;align-items:start}
#addForm label{display:flex;flex-direction:column;gap:6px;padding:10px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.015)}
#addForm .fieldWide{grid-column:1 / -1}
#addForm .addUserActions{grid-column:1 / -1;display:flex;justify-content:flex-end}
#addForm .addUserActions .btn{min-width:160px}
table{width:100%;border-collapse:collapse;margin-top:8px}th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:13px}th{color:rgba(255,255,255,.58);font-size:12px;text-transform:uppercase}
.folderRow{cursor:pointer}
.folderRow td:first-child{font-weight:600}
.folderRow:hover{background:rgba(255,255,255,.04)}
.folderNameBtn{display:inline-flex;align-items:center;gap:6px;padding:0;border:0;background:transparent;color:#fff;font:inherit;cursor:pointer;text-align:left}
.folderNameBtn:hover{color:#bfefff}
.badge{display:inline-block;padding:5px 8px;border-radius:999px;border:1px solid var(--line);font-size:11px}.ok{color:#7ef0a8}.dim{color:#f5b274}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.sectionTabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.sectionTabs .btn.active{background:linear-gradient(135deg,var(--a1),var(--a2));border:none;color:#061019;font-weight:700}
.sectionPane{display:none}
.sectionPane.active{display:block}
.kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
.kpi{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.02)}
.kpi strong{display:block;font-size:24px;line-height:1.1}
.kpi span{color:var(--muted);font-size:12px}
.fileForm{display:grid;grid-template-columns:1.2fr 1fr 1fr auto;gap:10px;align-items:end}
.folderForm{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end}
.fileTools{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:end}
.driveShell{display:grid;grid-template-columns:280px 1fr;gap:12px;margin-top:10px}
.driveTree{border:1px solid var(--line);border-radius:10px;padding:10px;min-height:320px;background:rgba(255,255,255,.02);overflow:auto}
.drivePane{border:1px solid var(--line);border-radius:10px;padding:10px;background:rgba(255,255,255,.02)}
.treeNode{display:flex;gap:8px;align-items:center;padding:7px 8px;border-radius:8px;cursor:pointer}
.treeNode:hover{background:rgba(255,255,255,.05)}
.treeNode.active{background:rgba(124,58,237,.25);border:1px solid rgba(124,58,237,.6)}
.treeSpacer{display:inline-block;width:14px}
.crumb{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;margin-right:6px;font-size:12px;color:var(--muted)}
.accessRow{display:flex;gap:10px;align-items:flex-start;margin-bottom:8px;padding:8px 10px;border:1px solid rgba(255,255,255,.08);border-radius:10px;background:rgba(255,255,255,.02)}
.accessRow input[type="checkbox"]{margin-top:2px;flex:0 0 auto}
.accessMeta{display:flex;flex-direction:column;gap:2px;line-height:1.35}
.accessName{color:#fff;font-size:13px}
.accessSub{color:rgba(255,255,255,.62);font-size:12px;word-break:break-word}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:1200;padding:16px}
.modal.open{display:flex}
.modalCard{width:min(640px,100%);max-height:85vh;overflow:auto;border:1px solid var(--line);border-radius:14px;background:#0c101a;padding:16px}
.modalHead{display:flex;justify-content:space-between;align-items:center;gap:10px}
.modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.companyGrid{display:grid;grid-template-columns:220px 1fr;gap:8px 12px;margin-top:8px}
.companyGrid div{padding:8px 10px;border:1px solid rgba(255,255,255,.08);border-radius:10px;background:rgba(255,255,255,.02)}
.companyGrid .k{color:rgba(255,255,255,.66);font-size:12px;text-transform:uppercase;letter-spacing:.04em}
.companyPreview{margin-top:10px;border:1px solid rgba(255,255,255,.08);border-radius:10px;overflow:hidden;max-width:520px}
.companyPreview img{display:block;width:100%;height:auto}
@media(max-width:920px){form{grid-template-columns:1fr}}
@media(max-width:920px){#addForm{grid-template-columns:1fr}}
@media(max-width:920px){.fileForm{grid-template-columns:1fr}}
@media(max-width:920px){.companyGrid{grid-template-columns:1fr}}
@media(max-width:920px){.folderForm{grid-template-columns:1fr}}
@media(max-width:920px){.fileTools{grid-template-columns:1fr}}
@media(max-width:980px){.driveShell{grid-template-columns:1fr}}
@media(max-width:800px){.kpis{grid-template-columns:1fr}}
</style>
</head><body><div class="wrap">
<div id="guard" class="card"><p>Checking session...</p></div>
<div id="portalContent" style="display:none">
  <div class="top"><h1>Admin Portal</h1><div><a class="btn" href="/update-admin.html">Updates Helper</a> <button class="btn" id="logout">Logout</button></div></div>

  <div class="sectionTabs" role="tablist" aria-label="Admin sections">
    <button class="btn active" id="tabUsers" data-tab="users" role="tab" aria-selected="true">Users</button>
    <button class="btn" id="tabSubmission" data-tab="submission" role="tab" aria-selected="false">App Submission</button>
    <button class="btn" id="tabFiles" data-tab="files" role="tab" aria-selected="false">Files</button>
  </div>

  <section class="sectionPane active" id="paneUsers" role="tabpanel" aria-labelledby="tabUsers">
    <div class="card">
      <p><strong>Add user</strong></p>
      <form id="addForm">
        <label>Name<input id="newFullName" type="text" placeholder="Client name"></label>
        <label>Company<input id="newCompany" type="text" placeholder="Company"></label>
        <label>Email<input id="newEmail" type="email" required></label>
        <label>Password<input id="newPassword" type="password" minlength="8" required></label>
        <label>Phone<input id="newPhone" type="text" placeholder="Phone"></label>
        <label>Project<input id="newProject" type="text" placeholder="Project"></label>
        <label>Role<select id="newRole"><option value="client">Client</option><option value="admin">Admin</option></select></label>
        <label>Portal headline<input id="newPortalTitle" type="text" placeholder="e.g. February rollout pack"></label>
        <label class="fieldWide">Notes<textarea id="newNotes" placeholder="Internal notes"></textarea></label>
        <label class="fieldWide">Portal info<textarea id="newPortalMessage" placeholder="Visible to this client inside their portal"></textarea></label>
        <label class="fieldWide">Download links<textarea id="newPortalDownloads" placeholder="One per line: Label | https://file-url | optional note"></textarea></label>
        <div class="addUserActions"><button class="btn primary" type="submit">Create user</button></div>
      </form>
      <p class="status" id="addStatus"></p>
    </div>

    <div class="card">
      <p><strong>Users</strong></p>
      <table>
        <thead><tr><th>Name</th><th>Company</th><th>Email</th><th>Role</th><th>Status</th><th>Last login</th><th>Actions</th></tr></thead>
        <tbody id="usersBody"><tr><td colspan="7">Loading...</td></tr></tbody>
      </table>
      <p class="status" id="tableStatus"></p>
    </div>
    <div class="card" id="userDocsCard" style="display:none">
      <p><strong id="userDocsTitle">Client documents</strong></p>
      <p id="userFolderPath" class="status" style="color:rgba(255,255,255,.72)">Path: <span class="crumb">Company files</span></p>
      <div class="fileTools">
        <label>Create folder<input id="userFolderName" type="text" placeholder="e.g. Contracts"></label>
        <div>
          <button class="btn" id="userCreateFolderBtn" type="button">Create folder</button>
          <button class="btn" id="userFolderUp" type="button">Up</button>
        </div>
      </div>
      <p class="status" id="userFolderStatus"></p>
      <div class="card" style="margin-top:10px">
        <p><strong>Main Folder Access</strong></p>
        <p class="status" id="userAccessStatus"></p>
        <div id="userAccessList"><p class="status">Select a client to manage access.</p></div>
      </div>
      <form id="userFileForm" class="fileForm">
        <label>Title<input id="userFileTitle" type="text" placeholder="Client document"></label>
        <label>Notes<input id="userFileNotes" type="text" placeholder="Optional note"></label>
        <label>Current folder<input id="userCurrentFolderLabel" type="text" value="/" readonly></label>
        <label>Choose file<input id="userFileInput" type="file" required></label>
        <button class="btn primary" type="submit">Upload</button>
      </form>
      <p class="status" id="userFileStatus"></p>
      <div class="driveShell">
        <aside class="driveTree">
          <p style="margin:0 0 8px;color:rgba(255,255,255,.65);font-size:12px;letter-spacing:.08em;text-transform:uppercase">Folders</p>
          <div id="userTree"><p class="status">No user selected.</p></div>
        </aside>
        <section class="drivePane">
          <table>
            <thead><tr><th>Name</th><th>Type</th><th>Modified</th><th>Actions</th></tr></thead>
            <tbody id="userItemsBody"><tr><td colspan="4">No user selected.</td></tr></tbody>
          </table>
        </section>
      </div>
    </div>
  </section>

  <section class="sectionPane" id="paneSubmission" role="tabpanel" aria-labelledby="tabSubmission">
    <div class="card">
      <p><strong>Overview</strong></p>
      <div class="kpis">
        <div class="kpi"><strong id="kpiTotal">0</strong><span>Total users</span></div>
        <div class="kpi"><strong id="kpiActive">0</strong><span>Active users</span></div>
        <div class="kpi"><strong id="kpiAdmins">0</strong><span>Admin users</span></div>
      </div>
    </div>
    <div class="card">
      <p><strong>Quick actions</strong></p>
      <p><a class="btn" href="/status.html">Open Status Page</a> <a class="btn" href="/updates.html">Open Updates Page</a> <a class="btn" href="/update-admin.html">Updates Helper</a></p>
      <p>Use the <strong>Users</strong> section to create client logins, disable access, reset passwords, or remove users.</p>
    </div>
    <div class="card">
      <p><strong>Apple Submission</strong></p>
      <p>
        <a class="btn" href="/apple-submission-checklist.md" target="_blank" rel="noopener">Open Apple Checklist</a>
      </p>
      <p><strong>App legal URLs</strong></p>
      <ul>
        <li>VOW: <a href="/vow/privacy.html" target="_blank" rel="noopener">Privacy</a> ‚Ä¢ <a href="/vow/terms.html" target="_blank" rel="noopener">Terms</a></li>
        <li>Site Survey Pro: <a href="/site-survey-pro-privacy.html" target="_blank" rel="noopener">Privacy</a> ‚Ä¢ <a href="/site-survey-pro-terms.html" target="_blank" rel="noopener">Terms</a></li>
        <li>TaskHawk: <a href="/taskhawk-privacy.html" target="_blank" rel="noopener">Privacy</a> ‚Ä¢ <a href="/taskhawk-terms.html" target="_blank" rel="noopener">Terms</a></li>
      </ul>
      <p class="status" style="color:rgba(255,255,255,.72)">This section is shown in Admin Portal only.</p>
    </div>
    <div class="card">
      <p><strong>Company Information</strong></p>
      <div class="companyGrid">
        <div class="k">D-U-N-S Number</div><div>234446756</div>
        <div class="k">Company Name</div><div>ORION GLE LTD</div>
        <div class="k">Legal Status</div><div>Corporation</div>
        <div class="k">Address</div><div>23A Meadowgate Croft, Lofthouse, Wakefield, WF3 3SS, GB</div>
      </div>
      <p style="margin-top:10px"><strong>Attached files</strong></p>
      <p>
        <a class="btn" href="/assets/company/112-543547_20251229-150102_17028.pdf" target="_blank" rel="noopener">Open Filing PDF 1</a>
        <a class="btn" href="/assets/company/112-543547_20251229_16933963.pdf" target="_blank" rel="noopener">Open Filing PDF 2</a>
      </p>
      <div class="companyPreview">
        <img src="/assets/company/DUNS.png" alt="D-U-N-S company information summary" loading="lazy" decoding="async">
      </div>
    </div>
  </section>

  <section class="sectionPane" id="paneFiles" role="tabpanel" aria-labelledby="tabFiles">
    <div class="card">
      <p><strong>File database</strong></p>
      <p id="generalFolderPath" class="status" style="color:rgba(255,255,255,.72)">Path: <span class="crumb">Company files</span></p>
      <form id="folderForm" class="folderForm">
        <label>Create folder in current path<input id="folderName" type="text" placeholder="e.g. Client Documents"></label>
        <div>
          <button class="btn" type="submit">Create folder</button>
          <button class="btn" id="generalFolderUp" type="button">Up</button>
        </div>
      </form>
      <p class="status" id="folderStatus"></p>
      <div id="generalAccessStatus" class="status" style="display:none"></div>
      <div id="generalAccessList" style="display:none"></div>
      <form id="fileForm" class="fileForm">
        <label>Title<input id="fileTitle" type="text" placeholder="Client briefing pack"></label>
        <label>Notes<input id="fileNotes" type="text" placeholder="Optional note"></label>
        <label>Current folder<input id="generalCurrentFolderLabel" type="text" value="/" readonly></label>
        <label>Choose file<input id="fileInput" type="file" required></label>
        <button class="btn primary" type="submit">Upload</button>
      </form>
      <p class="status" id="fileStatus"></p>
      <div class="driveShell">
        <aside class="driveTree">
          <p style="margin:0 0 8px;color:rgba(255,255,255,.65);font-size:12px;letter-spacing:.08em;text-transform:uppercase">Folders</p>
          <div id="generalTree"><p class="status">Loading...</p></div>
        </aside>
        <section class="drivePane">
          <table>
            <thead><tr><th>Name</th><th>Type</th><th>Modified</th><th>Actions</th></tr></thead>
            <tbody id="generalItemsBody"><tr><td colspan="4">Loading...</td></tr></tbody>
          </table>
        </section>
      </div>
    </div>
    <div class="card">
      <p><strong>Reset audit</strong></p>
      <p><button class="btn" id="refreshAudit" type="button">Refresh audit</button></p>
      <p class="status" id="resetAuditStatus"></p>
      <table>
        <thead><tr><th>When</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
        <tbody id="resetAuditBody"><tr><td colspan="4">Loading...</td></tr></tbody>
      </table>
    </div>
  </section>
  
  <div class="card">
    <p><strong>How this is used day-to-day</strong></p>
    <ul>
      <li>Create one login per client team or stakeholder.</li>
      <li>Disable users temporarily when needed without deleting them.</li>
      <li>Rotate passwords using Reset Password for access control.</li>
      <li>Keep only active users needed for current projects.</li>
    </ul>
  </div>
</div>
</div>
<div class="modal" id="accessModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHead">
      <p style="margin:0"><strong id="accessModalTitle">Manage folder access</strong></p>
      <button class="btn" id="accessModalClose" type="button">Close</button>
    </div>
    <p class="status" id="accessModalStatus" style="color:rgba(255,255,255,.72)"></p>
    <div id="accessModalList"><p class="status">Loading...</p></div>
    <div class="modalActions">
      <button class="btn" id="accessModalCancel" type="button">Cancel</button>
      <button class="btn primary" id="accessModalSave" type="button">Save access</button>
    </div>
  </div>
</div>
<script>
async function api(path, options){
  const res = await fetch(path, options);
  const data = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}
let currentUsersById = {};
let currentFilesById = {};
let currentFoldersById = {};
let currentFolders = [];
let generalCurrentFolderId = '';
let generalClientUsers = [];
let generalSharedFoldersById = {};
let currentUserDocFilesById = {};
let currentUserDocFoldersById = {};
let selectedUserDocsId = '';
let userCurrentFolderId = '';
let currentSharedFoldersById = {};
let accessModalState = { folderId: '', mainFolderId: '' };

function downloadsToText(downloads) {
  if (!Array.isArray(downloads) || !downloads.length) return '';
  return downloads
    .map((d) => {
      const label = (d && d.label ? String(d.label) : '').trim();
      const url = (d && d.url ? String(d.url) : '').trim();
      const note = (d && d.note ? String(d.note) : '').trim();
      return `${label} | ${url} | ${note}`.trim();
    })
    .join('\n');
}

function textToDownloads(text) {
  return String(text || '')
    .split('\n')
    .map((line) => line.trim())
    .filter(Boolean)
    .map((line) => {
      const parts = line.split('|');
      return {
        label: (parts[0] || '').trim(),
        url: (parts[1] || '').trim(),
        note: (parts[2] || '').trim()
      };
    })
    .filter((item) => item.url);
}

function formatBytes(bytes) {
  const n = Number(bytes || 0);
  if (!n) return "-";
  if (n < 1024) return `${n} B`;
  if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;
  return `${(n / (1024 * 1024)).toFixed(2)} MB`;
}

async function loadFiles() {
  const body = document.getElementById('generalItemsBody');
  const tree = document.getElementById('generalTree');
  body.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
  tree.innerHTML = '<p class="status">Loading...</p>';
  try {
    const data = await api('/api/admin/files');
    const usersData = await api('/api/admin/users');
    const rows = data.files || [];
    const folders = data.folders || [];
    generalClientUsers = (usersData.users || []).filter((u) => u.role === 'client' && u.active && u.source !== 'env');
    currentFilesById = {};
    currentFolders = folders;
    currentFoldersById = {};
    folders.forEach((f) => { currentFoldersById[f.id] = f; });
    renderGeneralTree(folders);
    renderGeneralItems(rows, folders);
    renderGeneralAccess();
  } catch (e) {
    body.innerHTML = `<tr><td colspan="4">${e.message}</td></tr>`;
    tree.innerHTML = `<p class="status">${e.message}</p>`;
  }
}

function getGeneralPathParts() {
  const parts = [];
  let cursor = generalCurrentFolderId;
  while (cursor && currentFoldersById[cursor]) {
    const f = currentFoldersById[cursor];
    parts.unshift(f.name);
    cursor = f.parentId || '';
  }
  return parts;
}

function getGeneralMainFolderId() {
  let cursor = generalCurrentFolderId;
  let last = '';
  while (cursor && currentFoldersById[cursor]) {
    const f = currentFoldersById[cursor];
    last = f.id;
    if (!f.parentId) return f.id;
    cursor = f.parentId || '';
  }
  return '';
}

function renderGeneralTree(folders) {
  const tree = document.getElementById('generalTree');
  const byParent = {};
  folders.forEach((f) => {
    const p = String(f.parentId || '');
    if (!byParent[p]) byParent[p] = [];
    byParent[p].push(f);
  });
  Object.keys(byParent).forEach((k) => byParent[k].sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''))));
  const rows = [];
  function walk(parentId, depth) {
    const list = byParent[parentId] || [];
    list.forEach((f) => {
      rows.push({ folder: f, depth });
      walk(String(f.id), depth + 1);
    });
  }
  walk('', 0);
  tree.innerHTML = '';
  const rootNode = document.createElement('div');
  rootNode.className = `treeNode ${generalCurrentFolderId ? '' : 'active'}`;
  rootNode.setAttribute('data-gtree-open', '');
  rootNode.setAttribute('data-id', '');
  rootNode.innerHTML = '<span>üóÇÔ∏è</span><span>Company files</span>';
  tree.appendChild(rootNode);
  if (!rows.length) {
    const empty = document.createElement('p');
    empty.className = 'status';
    empty.textContent = 'No folders yet.';
    tree.appendChild(empty);
    return;
  }
  rows.forEach(({ folder, depth }) => {
    const row = document.createElement('div');
    row.className = `treeNode ${String(folder.id) === generalCurrentFolderId ? 'active' : ''}`;
    row.setAttribute('data-gtree-open', '');
    row.setAttribute('data-id', folder.id);
    row.innerHTML = `${'<span class="treeSpacer"></span>'.repeat(depth)}<span>üìÅ</span><span>${folder.name}</span>`;
    tree.appendChild(row);
  });
}

function renderGeneralItems(files, folders) {
  const body = document.getElementById('generalItemsBody');
  const pathEl = document.getElementById('generalFolderPath');
  const pathParts = getGeneralPathParts();
  const chips = ['<span class="crumb">Company files</span>'].concat(pathParts.map((p) => `<span class="crumb">${p}</span>`)).join('');
  pathEl.innerHTML = `Path: ${chips}`;
  document.getElementById('generalCurrentFolderLabel').value = pathParts.length ? `/${pathParts.join('/')}` : '/';

  const visibleFolders = folders.filter((f) => String(f.parentId || '') === generalCurrentFolderId);
  const visibleFiles = files.filter((f) => String(f.folderId || '') === generalCurrentFolderId);
  body.innerHTML = '';
  if (!visibleFolders.length && !visibleFiles.length) {
    body.innerHTML = '<tr><td colspan="4">This folder is empty.</td></tr>';
    return;
  }
  visibleFolders.forEach((folder) => {
    const created = folder.createdAt ? new Date(folder.createdAt).toLocaleString() : '-';
    const tr = document.createElement('tr');
    tr.className = 'folderRow';
    tr.setAttribute('data-gopen', folder.id);
    tr.innerHTML = `<td><button class="folderNameBtn" data-gaction="manage-access" data-id="${folder.id}" type="button">üìÅ ${folder.name}</button></td><td>Folder</td><td>${created}</td><td><div class="actions"><button class="btn" data-gaction="open-folder" data-id="${folder.id}">Open</button><button class="btn" data-gaction="create-subfolder" data-id="${folder.id}">New subfolder</button><button class="btn" data-gaction="manage-access" data-id="${folder.id}">Manage access</button><button class="btn" data-gaction="rename-folder" data-id="${folder.id}">Rename</button><button class="btn" data-gaction="delete-folder" data-id="${folder.id}">Delete</button></div></td>`;
    body.appendChild(tr);
  });
  visibleFiles.forEach((file) => {
    currentFilesById[file.id] = file;
    const when = file.updatedAt || file.createdAt;
    const updated = when ? new Date(when).toLocaleString() : '-';
    const safeId = encodeURIComponent(file.id);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>üìÑ ${file.title || file.fileName || '-'}</td><td>File</td><td>${updated}</td><td><div class="actions"><a class="btn" href="/api/admin/files?id=${safeId}&inline=1" target="_blank" rel="noopener">View</a><a class="btn" href="/api/admin/files?id=${safeId}" target="_blank" rel="noopener">Download</a><button class="btn" data-gaction="edit-file" data-id="${file.id}">Edit</button><button class="btn" data-gaction="replace-file" data-id="${file.id}">Replace</button><button class="btn" data-gaction="delete-file" data-id="${file.id}">Delete</button></div></td>`;
    body.appendChild(tr);
  });
}

function renderGeneralAccess() {
  const root = document.getElementById('generalAccessList');
  const status = document.getElementById('generalAccessStatus');
  const mainId = getGeneralMainFolderId();
  if (!mainId || !currentFoldersById[mainId]) {
    root.innerHTML = '<p class="status">Open a main folder to manage client access.</p>';
    status.textContent = '';
    return;
  }
  const main = currentFoldersById[mainId];
  generalSharedFoldersById = { [main.id]: main };
  root.innerHTML = `<p class="status">Main folder: <strong>${main.name}</strong></p>`;
  if (!generalClientUsers.length) {
    root.innerHTML += '<p class="status">No active client users found.</p>';
    return;
  }
  generalClientUsers.forEach((u) => {
    const checked = (main.allowedUserIds || []).includes(u.id) ? 'checked' : '';
    const row = document.createElement('label');
    row.className = 'accessRow';
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.setAttribute('data-gaccess-toggle', '1');
    input.setAttribute('data-folder-id', String(main.id));
    input.setAttribute('data-user-id', String(u.id));
    input.checked = checked === 'checked';
    const meta = document.createElement('span');
    meta.className = 'accessMeta';
    const name = document.createElement('span');
    name.className = 'accessName';
    name.textContent = String(u.fullName || u.email || 'Client');
    const sub = document.createElement('span');
    sub.className = 'accessSub';
    sub.textContent = String(u.email || '');
    meta.appendChild(name);
    meta.appendChild(sub);
    row.appendChild(input);
    row.appendChild(meta);
    root.appendChild(row);
  });
}

function resolveMainFolder(folderId) {
  let folder = currentFoldersById[folderId] || null;
  while (folder && folder.parentId && currentFoldersById[folder.parentId]) {
    folder = currentFoldersById[folder.parentId];
  }
  return folder || null;
}

function openAccessModal(folderId) {
  const folder = currentFoldersById[folderId] || null;
  if (!folder) return;
  const mainFolder = resolveMainFolder(folderId);
  if (!mainFolder) return;
  accessModalState = { folderId, mainFolderId: mainFolder.id };
  const modal = document.getElementById('accessModal');
  const title = document.getElementById('accessModalTitle');
  const status = document.getElementById('accessModalStatus');
  const list = document.getElementById('accessModalList');

  title.textContent = folder.id === mainFolder.id
    ? `Manage access: ${mainFolder.name}`
    : `Manage access: ${folder.name} (inherits from ${mainFolder.name})`;

  if (!generalClientUsers.length) {
    list.innerHTML = '<p class="status">No active client users found.</p>';
  } else {
    list.innerHTML = '';
    generalClientUsers.forEach((u) => {
      const checked = (mainFolder.allowedUserIds || []).includes(u.id);
      const row = document.createElement('label');
      row.className = 'accessRow';
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.setAttribute('data-modal-access', '1');
      input.setAttribute('data-user-id', String(u.id));
      input.checked = checked;
      const meta = document.createElement('span');
      meta.className = 'accessMeta';
      const name = document.createElement('span');
      name.className = 'accessName';
      name.textContent = String(u.fullName || u.email || 'Client');
      const sub = document.createElement('span');
      sub.className = 'accessSub';
      sub.textContent = String(u.email || '');
      meta.appendChild(name);
      meta.appendChild(sub);
      row.appendChild(input);
      row.appendChild(meta);
      list.appendChild(row);
    });
  }

  status.textContent = folder.id === mainFolder.id
    ? 'Select which clients can access this main folder.'
    : `Access is controlled by main folder "${mainFolder.name}".`;
  modal.classList.add('open');
  modal.setAttribute('aria-hidden', 'false');
}

function closeAccessModal() {
  const modal = document.getElementById('accessModal');
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden', 'true');
}

function syncUserFolderUi(folders) {
  const pathEl = document.getElementById('userFolderPath');
  const currentFolderLabel = document.getElementById('userCurrentFolderLabel');
  const treeRoot = document.getElementById('userTree');

  currentUserDocFoldersById = {};
  folders.forEach((f) => { currentUserDocFoldersById[f.id] = f; });

  if (userCurrentFolderId && !currentUserDocFoldersById[userCurrentFolderId]) {
    userCurrentFolderId = '';
  }

  const pathParts = [];
  let cursor = userCurrentFolderId;
  while (cursor && currentUserDocFoldersById[cursor]) {
    const folder = currentUserDocFoldersById[cursor];
    pathParts.unshift(folder.name);
    cursor = folder.parentId || '';
  }
  const fullPath = `/${pathParts.join('/')}`;
  const chips = ['<span class="crumb">Company files</span>']
    .concat(pathParts.map((p) => `<span class="crumb">${p}</span>`))
    .join('');
  pathEl.innerHTML = `Path: ${chips}`;
  currentFolderLabel.value = fullPath === '/' ? '/' : fullPath;

  const byParent = {};
  folders.forEach((f) => {
    const p = String(f.parentId || '');
    if (!byParent[p]) byParent[p] = [];
    byParent[p].push(f);
  });
  Object.keys(byParent).forEach((k) => {
    byParent[k].sort((a, b) => String(a.name || '').localeCompare(String(b.name || '')));
  });

  const lines = [];
  function walk(parentId, depth) {
    const list = byParent[parentId] || [];
    list.forEach((f) => {
      lines.push({ folder: f, depth });
      walk(String(f.id), depth + 1);
    });
  }
  walk('', 0);

  treeRoot.innerHTML = '';
  const rootNode = document.createElement('div');
  rootNode.className = `treeNode ${userCurrentFolderId ? '' : 'active'}`;
  rootNode.setAttribute('data-utree-open', '');
  rootNode.setAttribute('data-id', '');
  rootNode.innerHTML = `<span>üóÇÔ∏è</span><span>Company files</span>`;
  treeRoot.appendChild(rootNode);

  if (!lines.length) {
    const empty = document.createElement('p');
    empty.className = 'status';
    empty.textContent = 'No folders yet.';
    treeRoot.appendChild(empty);
    return;
  }

  lines.forEach(({ folder, depth }) => {
    const row = document.createElement('div');
    row.className = `treeNode ${String(folder.id) === userCurrentFolderId ? 'active' : ''}`;
    row.setAttribute('data-utree-open', '');
    row.setAttribute('data-id', String(folder.id));
    row.innerHTML = `${'<span class="treeSpacer"></span>'.repeat(depth)}<span>üìÅ</span><span>${folder.name}</span>`;
    treeRoot.appendChild(row);
  });
}

function setSelectedUserDocs(userId) {
  selectedUserDocsId = userId || '';
  userCurrentFolderId = '';
  const card = document.getElementById('userDocsCard');
  const title = document.getElementById('userDocsTitle');
  const user = currentUsersById[selectedUserDocsId] || null;
  if (!user || user.source === 'env') {
    card.style.display = 'none';
    document.getElementById('userAccessList').innerHTML = '<p class="status">Select a client to manage access.</p>';
    return;
  }
  card.style.display = 'block';
  title.textContent = `Client documents ‚Äî ${user.fullName || user.email}`;
  loadUserDocs();
}

function renderSharedAccess(sharedFolders) {
  const root = document.getElementById('userAccessList');
  const topLevel = sharedFolders
    .filter((f) => !f.userId && !f.parentId)
    .sort((a, b) => String(a.name || '').localeCompare(String(b.name || '')));
  currentSharedFoldersById = {};
  topLevel.forEach((f) => { currentSharedFoldersById[f.id] = f; });

  if (!topLevel.length) {
    root.innerHTML = '<p class="status">No main folders found in Company files.</p>';
    return;
  }
  root.innerHTML = '';
  topLevel.forEach((folder) => {
    const id = `folderAccess_${folder.id}`;
    const checked = (folder.allowedUserIds || []).includes(selectedUserDocsId) ? 'checked' : '';
    const row = document.createElement('label');
    row.className = 'accessRow';
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.id = id;
    input.setAttribute('data-user-access', 'toggle');
    input.setAttribute('data-folder-id', String(folder.id));
    input.checked = checked === 'checked';
    const meta = document.createElement('span');
    meta.className = 'accessMeta';
    const name = document.createElement('span');
    name.className = 'accessName';
    name.textContent = String(folder.name || 'Main folder');
    const sub = document.createElement('span');
    sub.className = 'accessSub';
    sub.textContent = 'Main folder access';
    meta.appendChild(name);
    meta.appendChild(sub);
    row.appendChild(input);
    row.appendChild(meta);
    root.appendChild(row);
  });
}

async function loadUserDocs() {
  const itemsBody = document.getElementById('userItemsBody');
  const user = currentUsersById[selectedUserDocsId];
  if (!selectedUserDocsId || !user || user.source === 'env') {
    itemsBody.innerHTML = '<tr><td colspan="4">No user selected.</td></tr>';
    return;
  }
  itemsBody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
  try {
    const query = new URLSearchParams({ userId: selectedUserDocsId });
    const [data, sharedData] = await Promise.all([
      api(`/api/admin/files?${query.toString()}`),
      api('/api/admin/files')
    ]);
    const rows = data.files || [];
    const folders = data.folders || [];
    const sharedFolders = sharedData.folders || [];
    currentUserDocFilesById = {};
    syncUserFolderUi(folders);
    renderSharedAccess(sharedFolders);

    itemsBody.innerHTML = '';
    const visibleFolders = folders.filter((f) => String(f.parentId || '') === userCurrentFolderId);
    const scopedRows = rows.filter((f) => String(f.folderId || '') === userCurrentFolderId);
    if (!visibleFolders.length && !scopedRows.length) {
      itemsBody.innerHTML = '<tr><td colspan="4">This folder is empty.</td></tr>';
      return;
    }

    visibleFolders
      .sort((a, b) => String(a.name || '').localeCompare(String(b.name || '')))
      .forEach((folder) => {
        const tr = document.createElement('tr');
        const created = folder.createdAt ? new Date(folder.createdAt).toLocaleString() : '-';
        tr.className = 'folderRow';
        tr.setAttribute('data-uopen', folder.id);
        tr.innerHTML = `<td>üìÅ ${folder.name}</td><td>Folder</td><td>${created}</td><td><div class="actions"><button class="btn" data-ui-action="open-folder" data-id="${folder.id}">Open</button><button class="btn" data-ui-action="create-subfolder" data-id="${folder.id}">New subfolder</button><button class="btn" data-ui-action="delete-folder" data-id="${folder.id}">Delete</button></div></td>`;
        itemsBody.appendChild(tr);
      });

    scopedRows.forEach((file) => {
      currentUserDocFilesById[file.id] = file;
      const tr = document.createElement('tr');
      const uploaded = file.createdAt ? new Date(file.createdAt).toLocaleString() : '-';
      const safeId = encodeURIComponent(file.id);
      tr.innerHTML = `<td>üìÑ ${file.title || '-'}</td><td>File</td><td>${uploaded}</td><td><div class="actions"><a class="btn" href="/api/admin/files?id=${safeId}&inline=1" target="_blank" rel="noopener">View</a><a class="btn" href="/api/admin/files?id=${safeId}" target="_blank" rel="noopener">Download</a><button class="btn" data-ui-action="delete-file" data-id="${file.id}">Delete</button></div></td>`;
      itemsBody.appendChild(tr);
    });
  } catch (e) {
    itemsBody.innerHTML = `<tr><td colspan="4">${e.message}</td></tr>`;
  }
}

function formatAuditAction(action) {
  const a = String(action || '').trim();
  if (a === 'requested') return 'Reset requested';
  if (a === 'completed') return 'Reset completed';
  if (a === 'admin_reset') return 'Admin reset';
  if (a === 'required_due_inactivity') return 'Forced reset (inactivity)';
  return a || 'Unknown';
}

async function loadResetAudit() {
  const body = document.getElementById('resetAuditBody');
  const status = document.getElementById('resetAuditStatus');
  body.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
  status.textContent = '';
  try {
    const data = await api('/api/admin/reset-audit');
    const rows = data.events || [];
    body.innerHTML = '';
    if (!rows.length) {
      body.innerHTML = '<tr><td colspan="4">No reset audit events yet.</td></tr>';
      return;
    }
    rows.slice(0, 200).forEach((event) => {
      const tr = document.createElement('tr');
      const when = event.at ? new Date(event.at).toLocaleString() : '-';
      const user = `${event.name || '-'} (${event.email || '-'})`;
      const details = [];
      if (event.ip) details.push(`IP: ${event.ip}`);
      if (event.by) details.push(`By: ${event.by}`);
      if (event.days) details.push(`Days: ${event.days}`);
      tr.innerHTML = `<td>${when}</td><td>${user}</td><td>${formatAuditAction(event.action)}</td><td>${details.join(' | ') || '-'}</td>`;
      body.appendChild(tr);
    });
    status.textContent = `Showing ${Math.min(rows.length, 200)} of ${rows.length} event(s).`;
    status.style.color = 'rgba(255,255,255,.72)';
  } catch (e) {
    body.innerHTML = `<tr><td colspan="4">${e.message}</td></tr>`;
    status.textContent = 'Unable to load reset audit.';
  }
}

async function loadUsers(){
  const body = document.getElementById('usersBody');
  body.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
  try {
    const data = await api('/api/admin/users');
    const rows = data.users || [];
    currentUsersById = {};
    const total = rows.length;
    const activeCount = rows.filter((u) => u.active).length;
    const adminCount = rows.filter((u) => u.role === 'admin').length;
    document.getElementById('kpiTotal').textContent = String(total);
    document.getElementById('kpiActive').textContent = String(activeCount);
    document.getElementById('kpiAdmins').textContent = String(adminCount);
    body.innerHTML = '';
    rows.forEach(u=>{
      currentUsersById[u.id] = u;
      const tr = document.createElement('tr');
      const status = u.active ? '<span class="badge ok">Active</span>' : '<span class="badge dim">Disabled</span>';
      const actions = u.source === 'env'
        ? '<span class="badge">Env-managed</span>'
        : `<div class="actions"><button class="btn" data-a="edit" data-id="${u.id}">Edit Info</button><button class="btn" data-a="toggle" data-id="${u.id}" data-active="${u.active}">${u.active ? 'Disable' : 'Enable'}</button><button class="btn" data-a="reset" data-id="${u.id}">Reset Password</button><button class="btn" data-a="delete" data-id="${u.id}">Delete</button></div>`;
      tr.innerHTML = `<td>${u.fullName || '-'}</td><td>${u.company || '-'}</td><td>${u.email}</td><td>${u.role}</td><td>${status}</td><td>${u.lastLoginAt || '-'}</td><td>${actions}</td>`;
      body.appendChild(tr);
    });
  } catch (e) {
    body.innerHTML = `<tr><td colspan="7">${e.message}</td></tr>`;
  }
}

function setActiveTab(tab) {
  const isUsers = tab === 'users';
  const isSubmission = tab === 'submission';
  const isFiles = tab === 'files';
  document.getElementById('tabUsers').classList.toggle('active', isUsers);
  document.getElementById('tabSubmission').classList.toggle('active', isSubmission);
  document.getElementById('tabFiles').classList.toggle('active', isFiles);
  document.getElementById('tabUsers').setAttribute('aria-selected', isUsers ? 'true' : 'false');
  document.getElementById('tabSubmission').setAttribute('aria-selected', isSubmission ? 'true' : 'false');
  document.getElementById('tabFiles').setAttribute('aria-selected', isFiles ? 'true' : 'false');
  document.getElementById('paneUsers').classList.toggle('active', isUsers);
  document.getElementById('paneSubmission').classList.toggle('active', isSubmission);
  document.getElementById('paneFiles').classList.toggle('active', isFiles);
}

async function boot(){
  try {
    const me = await api('/api/auth/me');
    if(me.role !== 'admin') throw new Error('forbidden');
    document.getElementById('guard').remove();
    document.getElementById('portalContent').style.display = 'block';
    loadUsers();
    loadFiles();
    loadResetAudit();
  } catch {
    window.location.assign('/portal/login.html?next=/portal/admin.html');
  }
}

const addForm = document.getElementById('addForm');
addForm.addEventListener('submit', async function(e){
  e.preventDefault();
  const status = document.getElementById('addStatus');
  status.textContent = 'Creating user...';
  try {
    await api('/api/admin/users', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        fullName: document.getElementById('newFullName').value.trim(),
        company: document.getElementById('newCompany').value.trim(),
        email: document.getElementById('newEmail').value.trim(),
        password: document.getElementById('newPassword').value,
        phone: document.getElementById('newPhone').value.trim(),
        project: document.getElementById('newProject').value.trim(),
        notes: document.getElementById('newNotes').value.trim(),
        portalTitle: document.getElementById('newPortalTitle').value.trim(),
        portalMessage: document.getElementById('newPortalMessage').value.trim(),
        portalDownloads: textToDownloads(document.getElementById('newPortalDownloads').value),
        role: document.getElementById('newRole').value
      })
    });
    status.textContent = 'User created.';
    addForm.reset();
    loadUsers();
  } catch (e2) {
    status.textContent = e2.message;
  }
});

document.getElementById('fileForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const status = document.getElementById('fileStatus');
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files && fileInput.files[0];
  if (!file) {
    status.textContent = 'Choose a file first.';
    return;
  }
  if (file.size > 2 * 1024 * 1024) {
    status.textContent = 'File too large. Max size is 2 MB.';
    return;
  }
  status.textContent = 'Uploading...';
  try {
    const asBase64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = function(){ reject(new Error('Unable to read file.')); };
      reader.onload = function(){
        const data = String(reader.result || '');
        const idx = data.indexOf(',');
        resolve(idx >= 0 ? data.slice(idx + 1) : data);
      };
      reader.readAsDataURL(file);
    });

    await api('/api/admin/files', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        title: document.getElementById('fileTitle').value.trim(),
        notes: document.getElementById('fileNotes').value.trim(),
        folderId: generalCurrentFolderId,
        fileName: file.name,
        mimeType: file.type || 'application/octet-stream',
        contentBase64: asBase64
      })
    });

    status.textContent = 'File uploaded.';
    document.getElementById('fileForm').reset();
    loadFiles();
  } catch (err) {
    status.textContent = err.message || 'Upload failed.';
  }
});

document.getElementById('folderForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const status = document.getElementById('folderStatus');
  const name = document.getElementById('folderName').value.trim();
  if (!name) {
    status.textContent = 'Enter a folder name.';
    return;
  }
  status.textContent = 'Creating folder...';
  try {
    await api('/api/admin/files', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ type: 'folder', name, parentId: generalCurrentFolderId })
    });
    status.textContent = 'Folder created.';
    document.getElementById('folderForm').reset();
    loadFiles();
  } catch (err) {
    status.textContent = err.message || 'Unable to create folder.';
  }
});

document.getElementById('generalFolderUp').addEventListener('click', function(){
  const current = currentFoldersById[generalCurrentFolderId];
  generalCurrentFolderId = current ? (current.parentId || '') : '';
  loadFiles();
});

document.getElementById('generalTree').addEventListener('click', function(e){
  const node = e.target.closest('[data-gtree-open]');
  if (!node) return;
  generalCurrentFolderId = node.getAttribute('data-id') || '';
  loadFiles();
});

document.getElementById('generalAccessList').addEventListener('change', async function(e){
  const input = e.target.closest('input[data-gaccess-toggle]');
  if (!input) return;
  const folderId = input.getAttribute('data-folder-id');
  const userId = input.getAttribute('data-user-id');
  const folder = generalSharedFoldersById[folderId];
  const status = document.getElementById('generalAccessStatus');
  if (!folder || !folderId || !userId) return;

  const next = new Set(Array.isArray(folder.allowedUserIds) ? folder.allowedUserIds : []);
  if (input.checked) next.add(userId);
  else next.delete(userId);

  status.textContent = 'Saving access...';
  try {
    await api('/api/admin/files', {
      method: 'PATCH',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ id: folderId, allowedUserIds: Array.from(next) })
    });
    status.textContent = 'Access updated.';
    await loadFiles();
  } catch (err) {
    status.textContent = err.message || 'Unable to update access.';
  }
});

document.getElementById('generalItemsBody').addEventListener('click', async function(e){
  const row = e.target.closest('tr[data-gopen]');
  if (row && !e.target.closest('button') && !e.target.closest('a')) {
    generalCurrentFolderId = row.getAttribute('data-gopen') || '';
    loadFiles();
    return;
  }
  const btn = e.target.closest('button[data-gaction]');
  if (!btn) return;
  const action = btn.getAttribute('data-gaction');
  const id = btn.getAttribute('data-id');
  const folderStatus = document.getElementById('folderStatus');
  const fileStatus = document.getElementById('fileStatus');

  if (action === 'open-folder') {
    generalCurrentFolderId = id || '';
    loadFiles();
    return;
  }

  if (action === 'manage-access') {
    openAccessModal(id);
    return;
  }

  if (action === 'create-subfolder') {
    const parent = currentFoldersById[id];
    if (!parent) return;
    const inputName = prompt(`New subfolder inside "${parent.name}":`, '');
    if (inputName === null) return;
    const name = String(inputName || '').trim();
    if (!name) {
      folderStatus.textContent = 'Enter a subfolder name.';
      return;
    }
    folderStatus.textContent = 'Creating subfolder...';
    try {
      await api('/api/admin/files', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ type: 'folder', name, parentId: id })
      });
      folderStatus.textContent = 'Subfolder created.';
      generalCurrentFolderId = id;
      loadFiles();
    } catch (err) {
      folderStatus.textContent = err.message || 'Unable to create subfolder.';
    }
    return;
  }

  if (action === 'rename-folder') {
    const folder = currentFoldersById[id];
    if (!folder) return;
    const folderName = prompt('Folder name:', folder.name || '');
    if (folderName === null) return;
    folderStatus.textContent = 'Renaming folder...';
    try {
      await api('/api/admin/files', {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id, folderName })
      });
      folderStatus.textContent = 'Folder renamed.';
      loadFiles();
    } catch (err) {
      folderStatus.textContent = err.message || 'Rename failed.';
    }
    return;
  }

  if (action === 'delete-folder') {
    const folder = currentFoldersById[id];
    if (!confirm(`Delete folder "${folder && folder.name ? folder.name : 'this folder'}" and all subfolders/files?`)) return;
    folderStatus.textContent = 'Deleting folder...';
    try {
      await api('/api/admin/files', {
        method: 'DELETE',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ folderId: id })
      });
      folderStatus.textContent = 'Folder deleted.';
      if (generalCurrentFolderId === id) generalCurrentFolderId = '';
      loadFiles();
    } catch (err) {
      folderStatus.textContent = err.message || 'Delete failed.';
    }
    return;
  }

  if (action === 'edit-file') {
    const file = currentFilesById[id];
    if (!file) return;
    const title = prompt('Title:', file.title || file.fileName || '');
    if (title === null) return;
    const notes = prompt('Notes:', file.notes || '');
    if (notes === null) return;
    fileStatus.textContent = 'Saving file details...';
    try {
      await api('/api/admin/files', {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id, title, notes })
      });
      fileStatus.textContent = 'File details updated.';
      loadFiles();
    } catch (err) {
      fileStatus.textContent = err.message || 'Update failed.';
    }
    return;
  }

  if (action === 'replace-file') {
    const file = currentFilesById[id];
    if (!file) return;
    const picker = document.createElement('input');
    picker.type = 'file';
    picker.onchange = async function(){
      const nextFile = picker.files && picker.files[0];
      if (!nextFile) return;
      if (nextFile.size > 2 * 1024 * 1024) {
        fileStatus.textContent = 'File too large. Max size is 2 MB.';
        return;
      }
      fileStatus.textContent = 'Replacing file...';
      try {
        const contentBase64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onerror = function(){ reject(new Error('Unable to read file.')); };
          reader.onload = function(){
            const data = String(reader.result || '');
            const idx = data.indexOf(',');
            resolve(idx >= 0 ? data.slice(idx + 1) : data);
          };
          reader.readAsDataURL(nextFile);
        });
        await api('/api/admin/files', {
          method: 'PATCH',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            id,
            fileName: nextFile.name,
            mimeType: nextFile.type || 'application/octet-stream',
            contentBase64
          })
        });
        fileStatus.textContent = 'File replaced.';
        loadFiles();
      } catch (err) {
        fileStatus.textContent = err.message || 'Replace failed.';
      }
    };
    picker.click();
    return;
  }

  if (action === 'delete-file') {
    if (!confirm('Delete this file?')) return;
    fileStatus.textContent = 'Deleting file...';
    try {
      await api('/api/admin/files', {
        method: 'DELETE',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id })
      });
      fileStatus.textContent = 'File deleted.';
      loadFiles();
    } catch (err) {
      fileStatus.textContent = err.message || 'Delete failed.';
    }
  }
});

document.getElementById('userCreateFolderBtn').addEventListener('click', async function(){
  const status = document.getElementById('userFolderStatus');
  const user = currentUsersById[selectedUserDocsId];
  if (!selectedUserDocsId || !user || user.source === 'env') {
    status.textContent = 'Choose a client first from Users -> Docs.';
    return;
  }
  const name = document.getElementById('userFolderName').value.trim();
  if (!name) {
    status.textContent = 'Enter a folder name.';
    return;
  }
  status.textContent = 'Creating folder...';
  try {
    await api('/api/admin/files', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ type: 'folder', name, userId: selectedUserDocsId, parentId: userCurrentFolderId })
    });
    status.textContent = 'Folder created.';
    document.getElementById('userFolderName').value = '';
    loadUserDocs();
  } catch (err) {
    status.textContent = err.message || 'Unable to create folder.';
  }
});

document.getElementById('userTree').addEventListener('click', function(e){
  const node = e.target.closest('[data-utree-open]');
  if (!node) return;
  userCurrentFolderId = node.getAttribute('data-id') || '';
  loadUserDocs();
});

document.getElementById('userAccessList').addEventListener('change', async function(e){
  const input = e.target.closest('input[data-user-access="toggle"]');
  if (!input) return;
  const folderId = input.getAttribute('data-folder-id');
  const folder = currentSharedFoldersById[folderId];
  const status = document.getElementById('userAccessStatus');
  if (!folder || !selectedUserDocsId) return;

  const next = new Set(Array.isArray(folder.allowedUserIds) ? folder.allowedUserIds : []);
  if (input.checked) next.add(selectedUserDocsId);
  else next.delete(selectedUserDocsId);

  status.textContent = 'Saving access...';
  try {
    await api('/api/admin/files', {
      method: 'PATCH',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ id: folderId, allowedUserIds: Array.from(next) })
    });
    status.textContent = 'Access updated.';
    loadUserDocs();
  } catch (err) {
    status.textContent = err.message || 'Unable to update access.';
  }
});

document.getElementById('userItemsBody').addEventListener('click', async function(e){
  const row = e.target.closest('tr[data-uopen]');
  if (row && !e.target.closest('button') && !e.target.closest('a')) {
    userCurrentFolderId = row.getAttribute('data-uopen') || '';
    loadUserDocs();
    return;
  }
  const btn = e.target.closest('button[data-ui-action]');
  if (!btn) return;
  const action = btn.getAttribute('data-ui-action');
  const id = btn.getAttribute('data-id');
  const status = action === 'delete-file'
    ? document.getElementById('userFileStatus')
    : document.getElementById('userFolderStatus');

  if (action === 'open-folder') {
    userCurrentFolderId = id || '';
    loadUserDocs();
    return;
  }

  if (action === 'create-subfolder') {
    const parent = currentUserDocFoldersById[id];
    if (!parent) return;
    const inputName = prompt(`New subfolder inside "${parent.name}":`, '');
    if (inputName === null) return;
    const name = String(inputName || '').trim();
    if (!name) {
      status.textContent = 'Enter a subfolder name.';
      return;
    }
    status.textContent = 'Creating subfolder...';
    try {
      await api('/api/admin/files', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ type: 'folder', name, parentId: id, userId: selectedUserDocsId })
      });
      status.textContent = 'Subfolder created.';
      userCurrentFolderId = id;
      loadUserDocs();
    } catch (err) {
      status.textContent = err.message || 'Unable to create subfolder.';
    }
    return;
  }

  if (action === 'delete-folder') {
    const folder = currentUserDocFoldersById[id];
    if (!confirm(`Delete folder "${folder && folder.name ? folder.name : 'this folder'}" and all subfolders/files?`)) return;
    status.textContent = 'Deleting folder...';
    try {
      await api('/api/admin/files', {
        method: 'DELETE',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ folderId: id, userId: selectedUserDocsId })
      });
      status.textContent = 'Folder deleted.';
      loadUserDocs();
    } catch (err) {
      status.textContent = err.message || 'Delete failed.';
    }
    return;
  }

  if (action === 'delete-file') {
    if (!confirm('Delete this file from this client?')) return;
    status.textContent = 'Deleting...';
    try {
      await api('/api/admin/files', {
        method: 'DELETE',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id, userId: selectedUserDocsId })
      });
      status.textContent = 'File deleted.';
      loadUserDocs();
    } catch (err) {
      status.textContent = err.message || 'Delete failed.';
    }
  }
});

document.getElementById('userFolderUp').addEventListener('click', function(){
  const current = currentUserDocFoldersById[userCurrentFolderId];
  userCurrentFolderId = current ? (current.parentId || '') : '';
  loadUserDocs();
});

document.getElementById('userFileForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const status = document.getElementById('userFileStatus');
  const user = currentUsersById[selectedUserDocsId];
  if (!selectedUserDocsId || !user || user.source === 'env') {
    status.textContent = 'Choose a client first from Users -> Docs.';
    return;
  }
  const fileInput = document.getElementById('userFileInput');
  const file = fileInput.files && fileInput.files[0];
  if (!file) {
    status.textContent = 'Choose a file first.';
    return;
  }
  if (file.size > 2 * 1024 * 1024) {
    status.textContent = 'File too large. Max size is 2 MB.';
    return;
  }
  status.textContent = 'Uploading...';
  try {
    const asBase64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = function(){ reject(new Error('Unable to read file.')); };
      reader.onload = function(){
        const data = String(reader.result || '');
        const idx = data.indexOf(',');
        resolve(idx >= 0 ? data.slice(idx + 1) : data);
      };
      reader.readAsDataURL(file);
    });

    await api('/api/admin/files', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        userId: selectedUserDocsId,
        title: document.getElementById('userFileTitle').value.trim(),
        notes: document.getElementById('userFileNotes').value.trim(),
        folderId: userCurrentFolderId,
        fileName: file.name,
        mimeType: file.type || 'application/octet-stream',
        contentBase64: asBase64
      })
    });
    status.textContent = 'File uploaded.';
    document.getElementById('userFileForm').reset();
    loadUserDocs();
  } catch (err) {
    status.textContent = err.message || 'Upload failed.';
  }
});

document.getElementById('usersBody').addEventListener('click', async function(e){
  const btn = e.target.closest('button[data-a]');
  if(!btn) return;
  const action = btn.getAttribute('data-a');
  const id = btn.getAttribute('data-id');
  const tableStatus = document.getElementById('tableStatus');
  tableStatus.textContent = 'Working...';

  try {
    if(action === 'edit') {
      const u = currentUsersById[id] || {};
      const fullName = prompt('Name:', u.fullName || '');
      if(fullName === null) { tableStatus.textContent = ''; return; }
      const company = prompt('Company:', u.company || '');
      if(company === null) { tableStatus.textContent = ''; return; }
      const phone = prompt('Phone:', u.phone || '');
      if(phone === null) { tableStatus.textContent = ''; return; }
      const project = prompt('Project:', u.project || '');
      if(project === null) { tableStatus.textContent = ''; return; }
      const notes = prompt('Notes:', u.notes || '');
      if(notes === null) { tableStatus.textContent = ''; return; }
      const portalTitle = prompt('Portal headline:', u.portalTitle || '');
      if(portalTitle === null) { tableStatus.textContent = ''; return; }
      const portalMessage = prompt('Portal info:', u.portalMessage || '');
      if(portalMessage === null) { tableStatus.textContent = ''; return; }
      const portalDownloadsText = prompt('Download links (Label | URL | note, one per line):', downloadsToText(u.portalDownloads));
      if(portalDownloadsText === null) { tableStatus.textContent = ''; return; }
      await api('/api/admin/users', {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          id,
          fullName,
          company,
          phone,
          project,
          notes,
          portalTitle,
          portalMessage,
          portalDownloads: textToDownloads(portalDownloadsText)
        })
      });
    }
    if(action === 'toggle') {
      const active = btn.getAttribute('data-active') === 'true';
      await api('/api/admin/users', {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, active: !active})});
    }
    if(action === 'reset') {
      const next = prompt('Enter new password (8+ chars):');
      if(!next) { tableStatus.textContent = ''; return; }
      await api('/api/admin/users', {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, password: next})});
    }
    if(action === 'delete') {
      if(!confirm('Delete this user?')) { tableStatus.textContent = ''; return; }
      await api('/api/admin/users', {method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})});
    }
    tableStatus.textContent = 'Updated.';
    loadUsers();
    loadResetAudit();
  } catch (e3) {
    tableStatus.textContent = e3.message;
  }
});

document.getElementById('refreshAudit').addEventListener('click', function(){
  loadResetAudit();
});

document.getElementById('accessModalClose').addEventListener('click', closeAccessModal);
document.getElementById('accessModalCancel').addEventListener('click', closeAccessModal);
document.getElementById('accessModal').addEventListener('click', function(e){
  if (e.target.id === 'accessModal') closeAccessModal();
});
document.getElementById('accessModalSave').addEventListener('click', async function(){
  const mainFolderId = accessModalState.mainFolderId;
  const mainFolder = currentFoldersById[mainFolderId];
  const status = document.getElementById('accessModalStatus');
  if (!mainFolderId || !mainFolder) {
    status.textContent = 'Folder not available. Reloading...';
    await loadFiles();
    return;
  }
  const checks = Array.from(document.querySelectorAll('#accessModalList input[data-modal-access="1"]'));
  const next = checks.filter((i) => i.checked).map((i) => i.getAttribute('data-user-id')).filter(Boolean);
  status.textContent = 'Saving access...';
  try {
    await api('/api/admin/files', {
      method: 'PATCH',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ id: mainFolderId, allowedUserIds: next })
    });
    status.textContent = 'Access updated.';
    await loadFiles();
    setTimeout(closeAccessModal, 250);
  } catch (err) {
    status.textContent = err.message || 'Unable to update access.';
  }
});

document.getElementById('logout').addEventListener('click', async function(){
  await fetch('/api/auth/logout', {method:'POST'});
  window.location.assign('/portal/login.html');
});

document.getElementById('tabUsers').addEventListener('click', function(){ setActiveTab('users'); });
document.getElementById('tabSubmission').addEventListener('click', function(){ setActiveTab('submission'); });
document.getElementById('tabFiles').addEventListener('click', function(){ setActiveTab('files'); });

boot();
</script>
</body></html>
