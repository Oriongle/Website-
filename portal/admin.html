<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Portal â€” Orion GLE Ltd</title>
<meta name="robots" content="noindex,nofollow">
<link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
<style>
:root{--bg:#05070d;--text:#fff;--muted:rgba(255,255,255,.72);--line:rgba(255,255,255,.1);--a1:#7c3aed;--a2:#22d3ee}
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:#fff}
.wrap{max-width:1060px;margin:0 auto;padding:22px}.top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:#fff;text-decoration:none;cursor:pointer}
.btn.primary{border:none;background:linear-gradient(135deg,var(--a1),var(--a2));color:#061019;font-weight:700}
.card{margin-top:14px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:16px}
h1{margin:0 0 8px}p,li,label{color:var(--muted);line-height:1.7}.status{font-size:13px;color:#ff9aa2;min-height:20px}
form{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:end}input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:#fff}
textarea{min-height:74px;resize:vertical}
table{width:100%;border-collapse:collapse;margin-top:8px}th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:13px}th{color:rgba(255,255,255,.58);font-size:12px;text-transform:uppercase}
.badge{display:inline-block;padding:5px 8px;border-radius:999px;border:1px solid var(--line);font-size:11px}.ok{color:#7ef0a8}.dim{color:#f5b274}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.sectionTabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.sectionTabs .btn.active{background:linear-gradient(135deg,var(--a1),var(--a2));border:none;color:#061019;font-weight:700}
.sectionPane{display:none}
.sectionPane.active{display:block}
.kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
.kpi{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.02)}
.kpi strong{display:block;font-size:24px;line-height:1.1}
.kpi span{color:var(--muted);font-size:12px}
@media(max-width:920px){form{grid-template-columns:1fr}}
@media(max-width:800px){.kpis{grid-template-columns:1fr}}
</style>
</head><body><div class="wrap">
<div id="guard" class="card"><p>Checking session...</p></div>
<div id="portalContent" style="display:none">
  <div class="top"><h1>Admin Portal</h1><div><a class="btn" href="/update-admin.html">Updates Helper</a> <button class="btn" id="logout">Logout</button></div></div>

  <div class="sectionTabs" role="tablist" aria-label="Admin sections">
    <button class="btn active" id="tabUsers" data-tab="users" role="tab" aria-selected="true">Users</button>
    <button class="btn" id="tabGeneral" data-tab="general" role="tab" aria-selected="false">General</button>
  </div>

  <section class="sectionPane active" id="paneUsers" role="tabpanel" aria-labelledby="tabUsers">
    <div class="card">
      <p><strong>Add user</strong></p>
      <form id="addForm">
        <label>Name<input id="newFullName" type="text" placeholder="Client name"></label>
        <label>Company<input id="newCompany" type="text" placeholder="Company"></label>
        <label>Email<input id="newEmail" type="email" required></label>
        <label>Password<input id="newPassword" type="password" minlength="8" required></label>
        <label>Phone<input id="newPhone" type="text" placeholder="Phone"></label>
        <label>Project<input id="newProject" type="text" placeholder="Project"></label>
        <label>Role<select id="newRole"><option value="client">Client</option><option value="admin">Admin</option></select></label>
        <label style="grid-column:1 / span 3">Notes<textarea id="newNotes" placeholder="Notes"></textarea></label>
        <button class="btn primary" type="submit">Create</button>
      </form>
      <p class="status" id="addStatus"></p>
    </div>

    <div class="card">
      <p><strong>Users</strong></p>
      <table>
        <thead><tr><th>Name</th><th>Company</th><th>Email</th><th>Role</th><th>Status</th><th>Last login</th><th>Actions</th></tr></thead>
        <tbody id="usersBody"><tr><td colspan="7">Loading...</td></tr></tbody>
      </table>
      <p class="status" id="tableStatus"></p>
    </div>
  </section>

  <section class="sectionPane" id="paneGeneral" role="tabpanel" aria-labelledby="tabGeneral">
    <div class="card">
      <p><strong>Overview</strong></p>
      <div class="kpis">
        <div class="kpi"><strong id="kpiTotal">0</strong><span>Total users</span></div>
        <div class="kpi"><strong id="kpiActive">0</strong><span>Active users</span></div>
        <div class="kpi"><strong id="kpiAdmins">0</strong><span>Admin users</span></div>
      </div>
    </div>
    <div class="card">
      <p><strong>Quick actions</strong></p>
      <p><a class="btn" href="/status.html">Open Status Page</a> <a class="btn" href="/updates.html">Open Updates Page</a> <a class="btn" href="/update-admin.html">Updates Helper</a></p>
      <p>Use the <strong>Users</strong> section to create client logins, disable access, reset passwords, or remove users.</p>
    </div>
  </section>
  
  <div class="card">
    <p><strong>How this is used day-to-day</strong></p>
    <ul>
      <li>Create one login per client team or stakeholder.</li>
      <li>Disable users temporarily when needed without deleting them.</li>
      <li>Rotate passwords using Reset Password for access control.</li>
      <li>Keep only active users needed for current projects.</li>
    </ul>
  </div>
</div>
</div>
<script>
async function api(path, options){
  const res = await fetch(path, options);
  const data = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}
let currentUsersById = {};

async function loadUsers(){
  const body = document.getElementById('usersBody');
  body.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
  try {
    const data = await api('/api/admin/users');
    const rows = data.users || [];
    currentUsersById = {};
    const total = rows.length;
    const activeCount = rows.filter((u) => u.active).length;
    const adminCount = rows.filter((u) => u.role === 'admin').length;
    document.getElementById('kpiTotal').textContent = String(total);
    document.getElementById('kpiActive').textContent = String(activeCount);
    document.getElementById('kpiAdmins').textContent = String(adminCount);
    body.innerHTML = '';
    rows.forEach(u=>{
      currentUsersById[u.id] = u;
      const tr = document.createElement('tr');
      const status = u.active ? '<span class="badge ok">Active</span>' : '<span class="badge dim">Disabled</span>';
      const actions = u.source === 'env'
        ? '<span class="badge">Env-managed</span>'
        : `<div class="actions"><button class="btn" data-a="edit" data-id="${u.id}">Edit Info</button><button class="btn" data-a="toggle" data-id="${u.id}" data-active="${u.active}">${u.active ? 'Disable' : 'Enable'}</button><button class="btn" data-a="reset" data-id="${u.id}">Reset Password</button><button class="btn" data-a="delete" data-id="${u.id}">Delete</button></div>`;
      tr.innerHTML = `<td>${u.fullName || '-'}</td><td>${u.company || '-'}</td><td>${u.email}</td><td>${u.role}</td><td>${status}</td><td>${u.lastLoginAt || '-'}</td><td>${actions}</td>`;
      body.appendChild(tr);
    });
  } catch (e) {
    body.innerHTML = `<tr><td colspan="7">${e.message}</td></tr>`;
  }
}

function setActiveTab(tab) {
  const isUsers = tab === 'users';
  document.getElementById('tabUsers').classList.toggle('active', isUsers);
  document.getElementById('tabGeneral').classList.toggle('active', !isUsers);
  document.getElementById('tabUsers').setAttribute('aria-selected', isUsers ? 'true' : 'false');
  document.getElementById('tabGeneral').setAttribute('aria-selected', isUsers ? 'false' : 'true');
  document.getElementById('paneUsers').classList.toggle('active', isUsers);
  document.getElementById('paneGeneral').classList.toggle('active', !isUsers);
}

async function boot(){
  try {
    const me = await api('/api/auth/me');
    if(me.role !== 'admin') throw new Error('forbidden');
    document.getElementById('guard').remove();
    document.getElementById('portalContent').style.display = 'block';
    loadUsers();
  } catch {
    window.location.assign('/portal/login.html?next=/portal/admin.html');
  }
}

const addForm = document.getElementById('addForm');
addForm.addEventListener('submit', async function(e){
  e.preventDefault();
  const status = document.getElementById('addStatus');
  status.textContent = 'Creating user...';
  try {
    await api('/api/admin/users', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        fullName: document.getElementById('newFullName').value.trim(),
        company: document.getElementById('newCompany').value.trim(),
        email: document.getElementById('newEmail').value.trim(),
        password: document.getElementById('newPassword').value,
        phone: document.getElementById('newPhone').value.trim(),
        project: document.getElementById('newProject').value.trim(),
        notes: document.getElementById('newNotes').value.trim(),
        role: document.getElementById('newRole').value
      })
    });
    status.textContent = 'User created.';
    addForm.reset();
    loadUsers();
  } catch (e2) {
    status.textContent = e2.message;
  }
});

document.getElementById('usersBody').addEventListener('click', async function(e){
  const btn = e.target.closest('button[data-a]');
  if(!btn) return;
  const action = btn.getAttribute('data-a');
  const id = btn.getAttribute('data-id');
  const tableStatus = document.getElementById('tableStatus');
  tableStatus.textContent = 'Working...';

  try {
    if(action === 'edit') {
      const u = currentUsersById[id] || {};
      const fullName = prompt('Name:', u.fullName || '');
      if(fullName === null) { tableStatus.textContent = ''; return; }
      const company = prompt('Company:', u.company || '');
      if(company === null) { tableStatus.textContent = ''; return; }
      const phone = prompt('Phone:', u.phone || '');
      if(phone === null) { tableStatus.textContent = ''; return; }
      const project = prompt('Project:', u.project || '');
      if(project === null) { tableStatus.textContent = ''; return; }
      const notes = prompt('Notes:', u.notes || '');
      if(notes === null) { tableStatus.textContent = ''; return; }
      await api('/api/admin/users', {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, fullName, company, phone, project, notes})});
    }
    if(action === 'toggle') {
      const active = btn.getAttribute('data-active') === 'true';
      await api('/api/admin/users', {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, active: !active})});
    }
    if(action === 'reset') {
      const next = prompt('Enter new password (8+ chars):');
      if(!next) { tableStatus.textContent = ''; return; }
      await api('/api/admin/users', {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, password: next})});
    }
    if(action === 'delete') {
      if(!confirm('Delete this user?')) { tableStatus.textContent = ''; return; }
      await api('/api/admin/users', {method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})});
    }
    tableStatus.textContent = 'Updated.';
    loadUsers();
  } catch (e3) {
    tableStatus.textContent = e3.message;
  }
});

document.getElementById('logout').addEventListener('click', async function(){
  await fetch('/api/auth/logout', {method:'POST'});
  window.location.assign('/portal/login.html');
});

document.getElementById('tabUsers').addEventListener('click', function(){ setActiveTab('users'); });
document.getElementById('tabGeneral').addEventListener('click', function(){ setActiveTab('general'); });

boot();
</script>
</body></html>
