<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Portal — Orion GLE Ltd</title>
<meta name="robots" content="noindex,nofollow">
<link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
<style>
:root{--bg:#05070d;--text:#fff;--muted:rgba(255,255,255,.72);--line:rgba(255,255,255,.1);--a1:#7c3aed;--a2:#22d3ee}
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:#fff}
.wrap{max-width:1060px;margin:0 auto;padding:22px}.top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:#fff;text-decoration:none;cursor:pointer}
.btn.primary{border:none;background:linear-gradient(135deg,var(--a1),var(--a2));color:#061019;font-weight:700}
.card{margin-top:14px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:16px}
h1{margin:0 0 8px}p,li,label{color:var(--muted);line-height:1.7}.status{font-size:13px;color:#ff9aa2;min-height:20px}
form{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:end}input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:#fff}
textarea{min-height:74px;resize:vertical}
table{width:100%;border-collapse:collapse;margin-top:8px}th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:13px}th{color:rgba(255,255,255,.58);font-size:12px;text-transform:uppercase}
.badge{display:inline-block;padding:5px 8px;border-radius:999px;border:1px solid var(--line);font-size:11px}.ok{color:#7ef0a8}.dim{color:#f5b274}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.sectionTabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.sectionTabs .btn.active{background:linear-gradient(135deg,var(--a1),var(--a2));border:none;color:#061019;font-weight:700}
.sectionPane{display:none}
.sectionPane.active{display:block}
.kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
.kpi{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.02)}
.kpi strong{display:block;font-size:24px;line-height:1.1}
.kpi span{color:var(--muted);font-size:12px}
.fileForm{display:grid;grid-template-columns:1.2fr 1fr 1fr auto;gap:10px;align-items:end}
.folderForm{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end}
.fileTools{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:end}
@media(max-width:920px){form{grid-template-columns:1fr}}
@media(max-width:920px){.fileForm{grid-template-columns:1fr}}
@media(max-width:920px){.folderForm{grid-template-columns:1fr}}
@media(max-width:920px){.fileTools{grid-template-columns:1fr}}
@media(max-width:800px){.kpis{grid-template-columns:1fr}}
</style>
</head><body><div class="wrap">
<div id="guard" class="card"><p>Checking session...</p></div>
<div id="portalContent" style="display:none">
  <div class="top"><h1>Admin Portal</h1><div><a class="btn" href="/update-admin.html">Updates Helper</a> <button class="btn" id="logout">Logout</button></div></div>

  <div class="sectionTabs" role="tablist" aria-label="Admin sections">
    <button class="btn active" id="tabUsers" data-tab="users" role="tab" aria-selected="true">Users</button>
    <button class="btn" id="tabGeneral" data-tab="general" role="tab" aria-selected="false">General</button>
  </div>

  <section class="sectionPane active" id="paneUsers" role="tabpanel" aria-labelledby="tabUsers">
    <div class="card">
      <p><strong>Add user</strong></p>
      <form id="addForm">
        <label>Name<input id="newFullName" type="text" placeholder="Client name"></label>
        <label>Company<input id="newCompany" type="text" placeholder="Company"></label>
        <label>Email<input id="newEmail" type="email" required></label>
        <label>Password<input id="newPassword" type="password" minlength="8" required></label>
        <label>Phone<input id="newPhone" type="text" placeholder="Phone"></label>
        <label>Project<input id="newProject" type="text" placeholder="Project"></label>
        <label>Role<select id="newRole"><option value="client">Client</option><option value="admin">Admin</option></select></label>
        <label style="grid-column:1 / span 3">Notes<textarea id="newNotes" placeholder="Notes"></textarea></label>
        <label style="grid-column:1 / span 2">Portal headline<input id="newPortalTitle" type="text" placeholder="e.g. February rollout pack"></label>
        <label style="grid-column:1 / span 4">Portal info<textarea id="newPortalMessage" placeholder="Visible to this client inside their portal"></textarea></label>
        <label style="grid-column:1 / span 4">Download links<textarea id="newPortalDownloads" placeholder="One per line: Label | https://file-url | optional note"></textarea></label>
        <button class="btn primary" type="submit">Create</button>
      </form>
      <p class="status" id="addStatus"></p>
    </div>

    <div class="card">
      <p><strong>Users</strong></p>
      <table>
        <thead><tr><th>Name</th><th>Company</th><th>Email</th><th>Role</th><th>Status</th><th>Last login</th><th>Actions</th></tr></thead>
        <tbody id="usersBody"><tr><td colspan="7">Loading...</td></tr></tbody>
      </table>
      <p class="status" id="tableStatus"></p>
    </div>
    <div class="card" id="userDocsCard" style="display:none">
      <p><strong id="userDocsTitle">Client documents</strong></p>
      <form id="userFolderForm" class="folderForm">
        <label>Create folder<input id="userFolderName" type="text" placeholder="e.g. Contracts"></label>
        <button class="btn" type="submit">Create folder</button>
      </form>
      <div class="fileTools">
        <label>Filter folder<select id="userFolderFilter"><option value="">All folders</option></select></label>
      </div>
      <p class="status" id="userFolderStatus"></p>
      <table>
        <thead><tr><th>Folder</th><th>Created</th><th>Actions</th></tr></thead>
        <tbody id="userFoldersBody"><tr><td colspan="3">No user selected.</td></tr></tbody>
      </table>
      <form id="userFileForm" class="fileForm">
        <label>Title<input id="userFileTitle" type="text" placeholder="Client document"></label>
        <label>Notes<input id="userFileNotes" type="text" placeholder="Optional note"></label>
        <label>Folder<select id="userFileFolder"><option value="">No folder</option></select></label>
        <label>Choose file<input id="userFileInput" type="file" required></label>
        <button class="btn primary" type="submit">Upload</button>
      </form>
      <p class="status" id="userFileStatus"></p>
      <table>
        <thead><tr><th>Title</th><th>File</th><th>Folder</th><th>Size</th><th>Uploaded</th><th>Actions</th></tr></thead>
        <tbody id="userFilesBody"><tr><td colspan="6">No user selected.</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class="sectionPane" id="paneGeneral" role="tabpanel" aria-labelledby="tabGeneral">
    <div class="card">
      <p><strong>Overview</strong></p>
      <div class="kpis">
        <div class="kpi"><strong id="kpiTotal">0</strong><span>Total users</span></div>
        <div class="kpi"><strong id="kpiActive">0</strong><span>Active users</span></div>
        <div class="kpi"><strong id="kpiAdmins">0</strong><span>Admin users</span></div>
      </div>
    </div>
    <div class="card">
      <p><strong>Quick actions</strong></p>
      <p><a class="btn" href="/status.html">Open Status Page</a> <a class="btn" href="/updates.html">Open Updates Page</a> <a class="btn" href="/update-admin.html">Updates Helper</a></p>
      <p>Use the <strong>Users</strong> section to create client logins, disable access, reset passwords, or remove users.</p>
    </div>
    <div class="card">
      <p><strong>File database</strong></p>
      <form id="folderForm" class="folderForm">
        <label>Create folder<input id="folderName" type="text" placeholder="e.g. Client Documents"></label>
        <button class="btn" type="submit">Create folder</button>
      </form>
      <div class="fileTools">
        <label>Filter folder<select id="folderFilter"><option value="">All folders</option></select></label>
      </div>
      <p class="status" id="folderStatus"></p>
      <table>
        <thead><tr><th>Folder</th><th>Created</th><th>Actions</th></tr></thead>
        <tbody id="foldersBody"><tr><td colspan="3">Loading...</td></tr></tbody>
      </table>
      <form id="fileForm" class="fileForm">
        <label>Title<input id="fileTitle" type="text" placeholder="Client briefing pack"></label>
        <label>Notes<input id="fileNotes" type="text" placeholder="Optional note"></label>
        <label>Folder<select id="fileFolder"><option value="">No folder</option></select></label>
        <label>Choose file<input id="fileInput" type="file" required></label>
        <button class="btn primary" type="submit">Upload</button>
      </form>
      <p class="status" id="fileStatus"></p>
      <table>
        <thead><tr><th>Title</th><th>File</th><th>Folder</th><th>Size</th><th>Uploaded</th><th>Actions</th></tr></thead>
        <tbody id="filesBody"><tr><td colspan="6">Loading...</td></tr></tbody>
      </table>
    </div>
    <div class="card">
      <p><strong>Reset audit</strong></p>
      <p><button class="btn" id="refreshAudit" type="button">Refresh audit</button></p>
      <p class="status" id="resetAuditStatus"></p>
      <table>
        <thead><tr><th>When</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
        <tbody id="resetAuditBody"><tr><td colspan="4">Loading...</td></tr></tbody>
      </table>
    </div>
  </section>
  
  <div class="card">
    <p><strong>How this is used day-to-day</strong></p>
    <ul>
      <li>Create one login per client team or stakeholder.</li>
      <li>Disable users temporarily when needed without deleting them.</li>
      <li>Rotate passwords using Reset Password for access control.</li>
      <li>Keep only active users needed for current projects.</li>
    </ul>
  </div>
</div>
</div>
<script>
async function api(path, options){
  const res = await fetch(path, options);
  const data = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}
let currentUsersById = {};
let currentFilesById = {};
let currentFoldersById = {};
let currentFolders = [];
let currentUserDocFilesById = {};
let currentUserDocFoldersById = {};
let selectedUserDocsId = '';

function downloadsToText(downloads) {
  if (!Array.isArray(downloads) || !downloads.length) return '';
  return downloads
    .map((d) => {
      const label = (d && d.label ? String(d.label) : '').trim();
      const url = (d && d.url ? String(d.url) : '').trim();
      const note = (d && d.note ? String(d.note) : '').trim();
      return `${label} | ${url} | ${note}`.trim();
    })
    .join('\n');
}

function textToDownloads(text) {
  return String(text || '')
    .split('\n')
    .map((line) => line.trim())
    .filter(Boolean)
    .map((line) => {
      const parts = line.split('|');
      return {
        label: (parts[0] || '').trim(),
        url: (parts[1] || '').trim(),
        note: (parts[2] || '').trim()
      };
    })
    .filter((item) => item.url);
}

function formatBytes(bytes) {
  const n = Number(bytes || 0);
  if (!n) return "-";
  if (n < 1024) return `${n} B`;
  if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;
  return `${(n / (1024 * 1024)).toFixed(2)} MB`;
}

async function loadFiles() {
  const body = document.getElementById('filesBody');
  body.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
  try {
    const filterId = document.getElementById('folderFilter').value || '';
    const url = filterId
      ? `/api/admin/files?folderId=${encodeURIComponent(filterId)}`
      : '/api/admin/files';
    const data = await api(url);
    const rows = data.files || [];
    const folders = data.folders || [];
    currentFilesById = {};
    currentFolders = folders;
    currentFoldersById = {};
    folders.forEach((f) => { currentFoldersById[f.id] = f; });
    syncFolderUi(folders);
    body.innerHTML = '';
    if (!rows.length) {
      body.innerHTML = '<tr><td colspan="6">No files uploaded yet.</td></tr>';
      return;
    }
    const rowFolderOptions = ['<option value="">No folder</option>']
      .concat(folders.map((f) => `<option value="${f.id}">${f.name}</option>`))
      .join('');
    rows.forEach((file) => {
      currentFilesById[file.id] = file;
      const tr = document.createElement('tr');
      const uploaded = file.createdAt ? new Date(file.createdAt).toLocaleString() : '-';
      const safeId = encodeURIComponent(file.id);
      tr.innerHTML = `<td>${file.title || '-'}</td><td>${file.fileName || '-'}</td><td><select data-fa="folder" data-id="${file.id}">${rowFolderOptions}</select></td><td>${formatBytes(file.size)}</td><td>${uploaded}</td><td><div class="actions"><a class="btn" href="/api/admin/files?id=${safeId}&inline=1" target="_blank" rel="noopener">View</a><a class="btn" href="/api/admin/files?id=${safeId}" target="_blank" rel="noopener">Download</a><button class="btn" data-fa="move" data-id="${file.id}">Save folder</button><button class="btn" data-fa="delete" data-id="${file.id}">Delete</button></div></td>`;
      body.appendChild(tr);
      const select = tr.querySelector(`select[data-fa="folder"][data-id="${file.id}"]`);
      if (select) select.value = file.folderId || '';
    });
  } catch (e) {
    body.innerHTML = `<tr><td colspan="6">${e.message}</td></tr>`;
  }
}

function syncFolderUi(folders) {
  const folderFilter = document.getElementById('folderFilter');
  const fileFolder = document.getElementById('fileFolder');
  const foldersBody = document.getElementById('foldersBody');
  const selectedFilter = folderFilter.value || '';
  const selectedUpload = fileFolder.value || '';

  const options = ['<option value="">No folder</option>']
    .concat(folders.map((f) => `<option value="${f.id}">${f.name}</option>`))
    .join('');
  fileFolder.innerHTML = options;

  const filterOptions = ['<option value="">All folders</option>']
    .concat(folders.map((f) => `<option value="${f.id}">${f.name}</option>`))
    .join('');
  folderFilter.innerHTML = filterOptions;

  if (selectedFilter && folders.some((f) => f.id === selectedFilter)) {
    folderFilter.value = selectedFilter;
  } else {
    folderFilter.value = '';
  }
  if (selectedUpload && folders.some((f) => f.id === selectedUpload)) {
    fileFolder.value = selectedUpload;
  } else {
    fileFolder.value = '';
  }

  foldersBody.innerHTML = '';
  if (!folders.length) {
    foldersBody.innerHTML = '<tr><td colspan="3">No folders yet.</td></tr>';
    return;
  }
  folders.forEach((folder) => {
    const tr = document.createElement('tr');
    const created = folder.createdAt ? new Date(folder.createdAt).toLocaleString() : '-';
    tr.innerHTML = `<td>${folder.name}</td><td>${created}</td><td><button class="btn" data-fo="delete" data-id="${folder.id}">Delete</button></td>`;
    foldersBody.appendChild(tr);
  });
}

function syncUserFolderUi(folders) {
  const folderFilter = document.getElementById('userFolderFilter');
  const fileFolder = document.getElementById('userFileFolder');
  const foldersBody = document.getElementById('userFoldersBody');
  const selectedFilter = folderFilter.value || '';
  const selectedUpload = fileFolder.value || '';

  const options = ['<option value="">No folder</option>']
    .concat(folders.map((f) => `<option value="${f.id}">${f.name}</option>`))
    .join('');
  fileFolder.innerHTML = options;

  const filterOptions = ['<option value="">All folders</option>']
    .concat(folders.map((f) => `<option value="${f.id}">${f.name}</option>`))
    .join('');
  folderFilter.innerHTML = filterOptions;

  if (selectedFilter && folders.some((f) => f.id === selectedFilter)) folderFilter.value = selectedFilter;
  else folderFilter.value = '';
  if (selectedUpload && folders.some((f) => f.id === selectedUpload)) fileFolder.value = selectedUpload;
  else fileFolder.value = '';

  currentUserDocFoldersById = {};
  folders.forEach((f) => { currentUserDocFoldersById[f.id] = f; });
  foldersBody.innerHTML = '';
  if (!folders.length) {
    foldersBody.innerHTML = '<tr><td colspan="3">No folders yet.</td></tr>';
    return;
  }
  folders.forEach((folder) => {
    const tr = document.createElement('tr');
    const created = folder.createdAt ? new Date(folder.createdAt).toLocaleString() : '-';
    tr.innerHTML = `<td>${folder.name}</td><td>${created}</td><td><button class="btn" data-ufo="delete" data-id="${folder.id}">Delete</button></td>`;
    foldersBody.appendChild(tr);
  });
}

function setSelectedUserDocs(userId) {
  selectedUserDocsId = userId || '';
  const card = document.getElementById('userDocsCard');
  const title = document.getElementById('userDocsTitle');
  const user = currentUsersById[selectedUserDocsId] || null;
  if (!user || user.source === 'env') {
    card.style.display = 'none';
    return;
  }
  card.style.display = 'block';
  title.textContent = `Client documents — ${user.fullName || user.email}`;
  loadUserDocs();
}

async function loadUserDocs() {
  const filesBody = document.getElementById('userFilesBody');
  const user = currentUsersById[selectedUserDocsId];
  if (!selectedUserDocsId || !user || user.source === 'env') {
    filesBody.innerHTML = '<tr><td colspan="6">No user selected.</td></tr>';
    return;
  }
  filesBody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
  try {
    const filterId = document.getElementById('userFolderFilter').value || '';
    const query = new URLSearchParams({ userId: selectedUserDocsId });
    if (filterId) query.set('folderId', filterId);
    const data = await api(`/api/admin/files?${query.toString()}`);
    const rows = data.files || [];
    const folders = data.folders || [];
    currentUserDocFilesById = {};
    syncUserFolderUi(folders);

    filesBody.innerHTML = '';
    if (!rows.length) {
      filesBody.innerHTML = '<tr><td colspan="6">No files uploaded for this client.</td></tr>';
      return;
    }
    const rowFolderOptions = ['<option value="">No folder</option>']
      .concat(folders.map((f) => `<option value="${f.id}">${f.name}</option>`))
      .join('');
    rows.forEach((file) => {
      currentUserDocFilesById[file.id] = file;
      const tr = document.createElement('tr');
      const uploaded = file.createdAt ? new Date(file.createdAt).toLocaleString() : '-';
      const safeId = encodeURIComponent(file.id);
      tr.innerHTML = `<td>${file.title || '-'}</td><td>${file.fileName || '-'}</td><td><select data-ufa="folder" data-id="${file.id}">${rowFolderOptions}</select></td><td>${formatBytes(file.size)}</td><td>${uploaded}</td><td><div class="actions"><a class="btn" href="/api/admin/files?id=${safeId}&inline=1" target="_blank" rel="noopener">View</a><a class="btn" href="/api/admin/files?id=${safeId}" target="_blank" rel="noopener">Download</a><button class="btn" data-ufa="move" data-id="${file.id}">Save folder</button><button class="btn" data-ufa="delete" data-id="${file.id}">Delete</button></div></td>`;
      filesBody.appendChild(tr);
      const select = tr.querySelector(`select[data-ufa="folder"][data-id="${file.id}"]`);
      if (select) select.value = file.folderId || '';
    });
  } catch (e) {
    filesBody.innerHTML = `<tr><td colspan="6">${e.message}</td></tr>`;
  }
}

function formatAuditAction(action) {
  const a = String(action || '').trim();
  if (a === 'requested') return 'Reset requested';
  if (a === 'completed') return 'Reset completed';
  if (a === 'admin_reset') return 'Admin reset';
  if (a === 'required_due_inactivity') return 'Forced reset (inactivity)';
  return a || 'Unknown';
}

async function loadResetAudit() {
  const body = document.getElementById('resetAuditBody');
  const status = document.getElementById('resetAuditStatus');
  body.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
  status.textContent = '';
  try {
    const data = await api('/api/admin/reset-audit');
    const rows = data.events || [];
    body.innerHTML = '';
    if (!rows.length) {
      body.innerHTML = '<tr><td colspan="4">No reset audit events yet.</td></tr>';
      return;
    }
    rows.slice(0, 200).forEach((event) => {
      const tr = document.createElement('tr');
      const when = event.at ? new Date(event.at).toLocaleString() : '-';
      const user = `${event.name || '-'} (${event.email || '-'})`;
      const details = [];
      if (event.ip) details.push(`IP: ${event.ip}`);
      if (event.by) details.push(`By: ${event.by}`);
      if (event.days) details.push(`Days: ${event.days}`);
      tr.innerHTML = `<td>${when}</td><td>${user}</td><td>${formatAuditAction(event.action)}</td><td>${details.join(' | ') || '-'}</td>`;
      body.appendChild(tr);
    });
    status.textContent = `Showing ${Math.min(rows.length, 200)} of ${rows.length} event(s).`;
    status.style.color = 'rgba(255,255,255,.72)';
  } catch (e) {
    body.innerHTML = `<tr><td colspan="4">${e.message}</td></tr>`;
    status.textContent = 'Unable to load reset audit.';
  }
}

async function loadUsers(){
  const body = document.getElementById('usersBody');
  body.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
  try {
    const data = await api('/api/admin/users');
    const rows = data.users || [];
    currentUsersById = {};
    const total = rows.length;
    const activeCount = rows.filter((u) => u.active).length;
    const adminCount = rows.filter((u) => u.role === 'admin').length;
    document.getElementById('kpiTotal').textContent = String(total);
    document.getElementById('kpiActive').textContent = String(activeCount);
    document.getElementById('kpiAdmins').textContent = String(adminCount);
    body.innerHTML = '';
    rows.forEach(u=>{
      currentUsersById[u.id] = u;
      const tr = document.createElement('tr');
      const status = u.active ? '<span class="badge ok">Active</span>' : '<span class="badge dim">Disabled</span>';
      const actions = u.source === 'env'
        ? '<span class="badge">Env-managed</span>'
        : `<div class="actions"><button class="btn" data-a="docs" data-id="${u.id}">Docs</button><button class="btn" data-a="edit" data-id="${u.id}">Edit Info</button><button class="btn" data-a="toggle" data-id="${u.id}" data-active="${u.active}">${u.active ? 'Disable' : 'Enable'}</button><button class="btn" data-a="reset" data-id="${u.id}">Reset Password</button><button class="btn" data-a="delete" data-id="${u.id}">Delete</button></div>`;
      tr.innerHTML = `<td>${u.fullName || '-'}</td><td>${u.company || '-'}</td><td>${u.email}</td><td>${u.role}</td><td>${status}</td><td>${u.lastLoginAt || '-'}</td><td>${actions}</td>`;
      body.appendChild(tr);
    });
    if (selectedUserDocsId && currentUsersById[selectedUserDocsId]) {
      setSelectedUserDocs(selectedUserDocsId);
    } else if (selectedUserDocsId && !currentUsersById[selectedUserDocsId]) {
      selectedUserDocsId = '';
      document.getElementById('userDocsCard').style.display = 'none';
    }
  } catch (e) {
    body.innerHTML = `<tr><td colspan="7">${e.message}</td></tr>`;
  }
}

function setActiveTab(tab) {
  const isUsers = tab === 'users';
  document.getElementById('tabUsers').classList.toggle('active', isUsers);
  document.getElementById('tabGeneral').classList.toggle('active', !isUsers);
  document.getElementById('tabUsers').setAttribute('aria-selected', isUsers ? 'true' : 'false');
  document.getElementById('tabGeneral').setAttribute('aria-selected', isUsers ? 'false' : 'true');
  document.getElementById('paneUsers').classList.toggle('active', isUsers);
  document.getElementById('paneGeneral').classList.toggle('active', !isUsers);
}

async function boot(){
  try {
    const me = await api('/api/auth/me');
    if(me.role !== 'admin') throw new Error('forbidden');
    document.getElementById('guard').remove();
    document.getElementById('portalContent').style.display = 'block';
    loadUsers();
    loadFiles();
    loadResetAudit();
  } catch {
    window.location.assign('/portal/login.html?next=/portal/admin.html');
  }
}

const addForm = document.getElementById('addForm');
addForm.addEventListener('submit', async function(e){
  e.preventDefault();
  const status = document.getElementById('addStatus');
  status.textContent = 'Creating user...';
  try {
    await api('/api/admin/users', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        fullName: document.getElementById('newFullName').value.trim(),
        company: document.getElementById('newCompany').value.trim(),
        email: document.getElementById('newEmail').value.trim(),
        password: document.getElementById('newPassword').value,
        phone: document.getElementById('newPhone').value.trim(),
        project: document.getElementById('newProject').value.trim(),
        notes: document.getElementById('newNotes').value.trim(),
        portalTitle: document.getElementById('newPortalTitle').value.trim(),
        portalMessage: document.getElementById('newPortalMessage').value.trim(),
        portalDownloads: textToDownloads(document.getElementById('newPortalDownloads').value),
        role: document.getElementById('newRole').value
      })
    });
    status.textContent = 'User created.';
    addForm.reset();
    loadUsers();
  } catch (e2) {
    status.textContent = e2.message;
  }
});

document.getElementById('fileForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const status = document.getElementById('fileStatus');
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files && fileInput.files[0];
  if (!file) {
    status.textContent = 'Choose a file first.';
    return;
  }
  if (file.size > 2 * 1024 * 1024) {
    status.textContent = 'File too large. Max size is 2 MB.';
    return;
  }
  status.textContent = 'Uploading...';
  try {
    const asBase64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = function(){ reject(new Error('Unable to read file.')); };
      reader.onload = function(){
        const data = String(reader.result || '');
        const idx = data.indexOf(',');
        resolve(idx >= 0 ? data.slice(idx + 1) : data);
      };
      reader.readAsDataURL(file);
    });

    await api('/api/admin/files', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        title: document.getElementById('fileTitle').value.trim(),
        notes: document.getElementById('fileNotes').value.trim(),
        folderId: document.getElementById('fileFolder').value || '',
        fileName: file.name,
        mimeType: file.type || 'application/octet-stream',
        contentBase64: asBase64
      })
    });

    status.textContent = 'File uploaded.';
    document.getElementById('fileForm').reset();
    loadFiles();
  } catch (err) {
    status.textContent = err.message || 'Upload failed.';
  }
});

document.getElementById('folderForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const status = document.getElementById('folderStatus');
  const name = document.getElementById('folderName').value.trim();
  if (!name) {
    status.textContent = 'Enter a folder name.';
    return;
  }
  status.textContent = 'Creating folder...';
  try {
    await api('/api/admin/files', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ type: 'folder', name })
    });
    status.textContent = 'Folder created.';
    document.getElementById('folderForm').reset();
    loadFiles();
  } catch (err) {
    status.textContent = err.message || 'Unable to create folder.';
  }
});

document.getElementById('folderFilter').addEventListener('change', function(){
  loadFiles();
});

document.getElementById('userFolderFilter').addEventListener('change', function(){
  loadUserDocs();
});

document.getElementById('userFolderForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const status = document.getElementById('userFolderStatus');
  const user = currentUsersById[selectedUserDocsId];
  if (!selectedUserDocsId || !user || user.source === 'env') {
    status.textContent = 'Choose a client first from Users -> Docs.';
    return;
  }
  const name = document.getElementById('userFolderName').value.trim();
  if (!name) {
    status.textContent = 'Enter a folder name.';
    return;
  }
  status.textContent = 'Creating folder...';
  try {
    await api('/api/admin/files', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ type: 'folder', name, userId: selectedUserDocsId })
    });
    status.textContent = 'Folder created.';
    document.getElementById('userFolderForm').reset();
    loadUserDocs();
  } catch (err) {
    status.textContent = err.message || 'Unable to create folder.';
  }
});

document.getElementById('userFoldersBody').addEventListener('click', async function(e){
  const btn = e.target.closest('button[data-ufo]');
  if (!btn) return;
  const action = btn.getAttribute('data-ufo');
  const id = btn.getAttribute('data-id');
  const status = document.getElementById('userFolderStatus');
  if (action !== 'delete') return;
  const folder = currentUserDocFoldersById[id];
  if (!confirm(`Delete folder "${folder && folder.name ? folder.name : 'this folder'}"? Files will be moved to No folder.`)) return;
  status.textContent = 'Deleting folder...';
  try {
    await api('/api/admin/files', {
      method: 'DELETE',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ folderId: id, userId: selectedUserDocsId })
    });
    status.textContent = 'Folder deleted.';
    loadUserDocs();
  } catch (err) {
    status.textContent = err.message || 'Delete failed.';
  }
});

document.getElementById('userFileForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const status = document.getElementById('userFileStatus');
  const user = currentUsersById[selectedUserDocsId];
  if (!selectedUserDocsId || !user || user.source === 'env') {
    status.textContent = 'Choose a client first from Users -> Docs.';
    return;
  }
  const fileInput = document.getElementById('userFileInput');
  const file = fileInput.files && fileInput.files[0];
  if (!file) {
    status.textContent = 'Choose a file first.';
    return;
  }
  if (file.size > 2 * 1024 * 1024) {
    status.textContent = 'File too large. Max size is 2 MB.';
    return;
  }
  status.textContent = 'Uploading...';
  try {
    const asBase64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = function(){ reject(new Error('Unable to read file.')); };
      reader.onload = function(){
        const data = String(reader.result || '');
        const idx = data.indexOf(',');
        resolve(idx >= 0 ? data.slice(idx + 1) : data);
      };
      reader.readAsDataURL(file);
    });

    await api('/api/admin/files', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        userId: selectedUserDocsId,
        title: document.getElementById('userFileTitle').value.trim(),
        notes: document.getElementById('userFileNotes').value.trim(),
        folderId: document.getElementById('userFileFolder').value || '',
        fileName: file.name,
        mimeType: file.type || 'application/octet-stream',
        contentBase64: asBase64
      })
    });
    status.textContent = 'File uploaded.';
    document.getElementById('userFileForm').reset();
    loadUserDocs();
  } catch (err) {
    status.textContent = err.message || 'Upload failed.';
  }
});

document.getElementById('userFilesBody').addEventListener('click', async function(e){
  const btn = e.target.closest('button[data-ufa]');
  if (!btn) return;
  const action = btn.getAttribute('data-ufa');
  const id = btn.getAttribute('data-id');
  const status = document.getElementById('userFileStatus');

  if (action === 'move') {
    const select = document.querySelector(`select[data-ufa="folder"][data-id="${id}"]`);
    const folderId = select ? (select.value || '') : '';
    status.textContent = 'Updating folder...';
    try {
      await api('/api/admin/files', {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id, userId: selectedUserDocsId, folderId })
      });
      status.textContent = 'Folder updated.';
      loadUserDocs();
    } catch (err) {
      status.textContent = err.message || 'Update failed.';
    }
    return;
  }

  if (action === 'delete') {
    if (!confirm('Delete this file from this client?')) return;
    status.textContent = 'Deleting...';
    try {
      await api('/api/admin/files', {
        method: 'DELETE',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id, userId: selectedUserDocsId })
      });
      status.textContent = 'File deleted.';
      loadUserDocs();
    } catch (err) {
      status.textContent = err.message || 'Delete failed.';
    }
  }
});

document.getElementById('foldersBody').addEventListener('click', async function(e){
  const btn = e.target.closest('button[data-fo]');
  if (!btn) return;
  const action = btn.getAttribute('data-fo');
  const id = btn.getAttribute('data-id');
  const status = document.getElementById('folderStatus');
  if (action !== 'delete') return;
  const folder = currentFoldersById[id];
  if (!confirm(`Delete folder "${folder && folder.name ? folder.name : 'this folder'}"? Files will be moved to No folder.`)) return;
  status.textContent = 'Deleting folder...';
  try {
    await api('/api/admin/files', {
      method: 'DELETE',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ folderId: id })
    });
    status.textContent = 'Folder deleted.';
    loadFiles();
  } catch (err) {
    status.textContent = err.message || 'Delete failed.';
  }
});

document.getElementById('filesBody').addEventListener('click', async function(e){
  const btn = e.target.closest('button[data-fa]');
  if (!btn) return;
  const action = btn.getAttribute('data-fa');
  const id = btn.getAttribute('data-id');
  const status = document.getElementById('fileStatus');
  if (action === 'move') {
    const select = document.querySelector(`select[data-fa="folder"][data-id="${id}"]`);
    const folderId = select ? (select.value || '') : '';
    status.textContent = 'Updating folder...';
    try {
      await api('/api/admin/files', {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id, folderId })
      });
      status.textContent = 'Folder updated.';
      loadFiles();
    } catch (err) {
      status.textContent = err.message || 'Update failed.';
    }
    return;
  }

  if (action === 'delete') {
    if (!confirm('Delete this file from database?')) return;
    status.textContent = 'Deleting...';
    try {
      await api('/api/admin/files', {
        method: 'DELETE',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id })
      });
      status.textContent = 'File deleted.';
      loadFiles();
    } catch (err) {
      status.textContent = err.message || 'Delete failed.';
    }
  }
});

document.getElementById('usersBody').addEventListener('click', async function(e){
  const btn = e.target.closest('button[data-a]');
  if(!btn) return;
  const action = btn.getAttribute('data-a');
  const id = btn.getAttribute('data-id');
  const tableStatus = document.getElementById('tableStatus');
  tableStatus.textContent = 'Working...';

  try {
    if(action === 'docs') {
      setSelectedUserDocs(id);
      tableStatus.textContent = '';
      return;
    }
    if(action === 'edit') {
      const u = currentUsersById[id] || {};
      const fullName = prompt('Name:', u.fullName || '');
      if(fullName === null) { tableStatus.textContent = ''; return; }
      const company = prompt('Company:', u.company || '');
      if(company === null) { tableStatus.textContent = ''; return; }
      const phone = prompt('Phone:', u.phone || '');
      if(phone === null) { tableStatus.textContent = ''; return; }
      const project = prompt('Project:', u.project || '');
      if(project === null) { tableStatus.textContent = ''; return; }
      const notes = prompt('Notes:', u.notes || '');
      if(notes === null) { tableStatus.textContent = ''; return; }
      const portalTitle = prompt('Portal headline:', u.portalTitle || '');
      if(portalTitle === null) { tableStatus.textContent = ''; return; }
      const portalMessage = prompt('Portal info:', u.portalMessage || '');
      if(portalMessage === null) { tableStatus.textContent = ''; return; }
      const portalDownloadsText = prompt('Download links (Label | URL | note, one per line):', downloadsToText(u.portalDownloads));
      if(portalDownloadsText === null) { tableStatus.textContent = ''; return; }
      await api('/api/admin/users', {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          id,
          fullName,
          company,
          phone,
          project,
          notes,
          portalTitle,
          portalMessage,
          portalDownloads: textToDownloads(portalDownloadsText)
        })
      });
    }
    if(action === 'toggle') {
      const active = btn.getAttribute('data-active') === 'true';
      await api('/api/admin/users', {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, active: !active})});
    }
    if(action === 'reset') {
      const next = prompt('Enter new password (8+ chars):');
      if(!next) { tableStatus.textContent = ''; return; }
      await api('/api/admin/users', {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, password: next})});
    }
    if(action === 'delete') {
      if(!confirm('Delete this user?')) { tableStatus.textContent = ''; return; }
      await api('/api/admin/users', {method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})});
    }
    tableStatus.textContent = 'Updated.';
    loadUsers();
    loadResetAudit();
  } catch (e3) {
    tableStatus.textContent = e3.message;
  }
});

document.getElementById('refreshAudit').addEventListener('click', function(){
  loadResetAudit();
});

document.getElementById('logout').addEventListener('click', async function(){
  await fetch('/api/auth/logout', {method:'POST'});
  window.location.assign('/portal/login.html');
});

document.getElementById('tabUsers').addEventListener('click', function(){ setActiveTab('users'); });
document.getElementById('tabGeneral').addEventListener('click', function(){ setActiveTab('general'); });

boot();
</script>
</body></html>
